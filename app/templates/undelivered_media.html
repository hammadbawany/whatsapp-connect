<!DOCTYPE html>
<html>
<head>
<title>Undelivered Media Monitor</title>

<style>

body {
    font-family: Arial;
    background: #0c1317;
    color: white;
    padding: 20px;
}

h2 {
    color: #25D366;
}

.controls {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
}

.refresh {
    background: #25D366;
    color: black;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
}

.counter {
    background: #202c33;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: bold;
}

/* Table */

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    background: #202c33;
    padding: 12px;
}

td {
    padding: 10px;
    border-bottom: 1px solid #2a3942;
}

tr:hover {
    background: #1f2c34;
    cursor: pointer;
}

/* Status Badge */

.badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: bold;
}

/* Buttons */

.retry-btn {
    background: #ffaa00;
    border: none;
    padding: 6px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
}

.delivered-btn {
    background: #2b8cff;
    border: none;
    padding: 6px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    margin-left: 6px;
}

/* Expired Label */

.expired {
    color: #ff3b3b;
    font-weight: bold;
    font-size: 12px;
}

/* Old Highlight */

.old {
    background: #2a1515 !important;
}

/* Empty */

.empty {
    text-align: center;
    padding: 20px;
    color: #8696a0;
}

/* Fade Remove */

.fade-out {
    animation: fadeOut 0.4s forwards;
}

@keyframes fadeOut {
    to {
        opacity: 0;
        height: 0;
    }
}

/* Right Click Menu */

#contextMenu {
    position: fixed;
    background: #202c33;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    display: none;
    z-index: 9999;
    min-width: 160px;
}

.ctx-item {
    padding: 10px 14px;
    cursor: pointer;
}

.ctx-item:hover {
    background: #2a3942;
}

</style>
</head>

<body>

<h2>ðŸ“¸ Undelivered Media Monitor</h2>

<div class="controls">
    <button class="refresh" onclick="loadData()">Refresh</button>
    <div class="counter" id="counter">0 Pending</div>
</div>

<table>
<thead>
<tr>
    <th>Phone</th>
    <th>Media</th>
    <th>Caption</th>
    <th>Timestamp</th>
    <th>Status</th>
    <th>Actions</th>
</tr>
</thead>

<tbody id="rows"></tbody>
</table>


<!-- Right Click Menu -->
<div id="contextMenu">
    <div class="ctx-item" onclick="ctxOpenChat()">Open Chat</div>
    <div class="ctx-item" onclick="ctxRetry()">Retry Media</div>
    <div class="ctx-item" onclick="ctxMarkDelivered()">Mark Delivered</div>
</div>


<script>

let cache = new Map();
let selectedWhatsappId = null;
let selectedPhone = null;


// LOAD DATA
async function loadData(){

    const res = await fetch("/api/undelivered_media");
    const data = await res.json();

    const tbody = document.getElementById("rows");
    const counter = document.getElementById("counter");

    counter.innerText = `${data.length} Pending`;

    const newSet = new Set();

    data.forEach(row => {

        newSet.add(row.whatsapp_id);

        if(cache.has(row.whatsapp_id)) return;

        cache.set(row.whatsapp_id, row);

        const tr = document.createElement("tr");
        tr.id = row.whatsapp_id;

        // Time calculation
        const msgTime = new Date(row.timestamp);
        const ageMin = (Date.now() - msgTime) / 60000;
        const expired = (ageMin / 60) > 24;

        if(ageMin > 10){
            tr.classList.add("old");
        }

        // Status badge
        let statusLabel = row.status === "failed" ? "FAILED" : "SINGLE TICK";
        let statusColor = row.status === "failed" ? "#ff0000" : "#ff3b3b";

        // Action buttons
        let retryHtml = expired
            ? `<span class="expired">TIME EXPIRED</span>`
            : `<button class="retry-btn" onclick="retrySend(event,'${row.whatsapp_id}')">Retry</button>`;

        // Click â†’ open inbox new tab
        tr.onclick = () => {
            window.open(`/inbox?phone=${row.user_phone}`, "_blank");
        };

        // Right click menu
        tr.oncontextmenu = (e) => {
            e.preventDefault();
            selectedWhatsappId = row.whatsapp_id;
            selectedPhone = row.user_phone;
            showContextMenu(e.pageX, e.pageY);
        };

        tr.innerHTML = `
            <td>${row.user_phone}</td>
            <td>${row.media_type}</td>
            <td>${row.message || "-"}</td>
            <td>${new Date(row.timestamp).toLocaleString('en-GB')}</td>
            <td>
                <span class="badge" style="background:${statusColor}">
                    ${statusLabel}
                </span>
            </td>
            <td>
                ${retryHtml}
                <button class="delivered-btn"
                        onclick="markDelivered(event,'${row.whatsapp_id}')">
                    Mark Delivered
                </button>
            </td>
        `;

        tbody.appendChild(tr);
    });

    // Auto remove resolved rows
    cache.forEach((v, key) => {

        if(!newSet.has(key)){

            const row = document.getElementById(key);

            if(row){
                row.classList.add("fade-out");
                setTimeout(() => row.remove(), 400);
            }

            cache.delete(key);
        }

    });

    if(data.length === 0){
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="empty">
                    âœ… No undelivered media
                </td>
            </tr>
        `;
    }
}


// RETRY
async function retrySend(event, wa_id){

    event.stopPropagation();

    const btn = event.target;
    btn.disabled = true;
    btn.innerText = "Sending...";

    const res = await fetch("/api/retry_media", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ whatsapp_id: wa_id })
    });

    const data = await res.json();

    if(data.success){
        btn.innerText = "Sent âœ”";
        btn.style.background = "#25D366";
    } else {
        btn.innerText = "Failed";
        btn.style.background = "red";
    }
}


// MARK DELIVERED
async function markDelivered(event, wa_id){

    event.stopPropagation();

    if(!confirm("Mark this message as delivered?")) return;

    const res = await fetch("/api/mark_delivered", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ whatsapp_id: wa_id })
    });

    const data = await res.json();

    if(data.success){

        const row = document.getElementById(wa_id);

        if(row){
            row.classList.add("fade-out");
            setTimeout(() => row.remove(), 400);
        }

        cache.delete(wa_id);
    }
}


// CONTEXT MENU
function showContextMenu(x, y){
    const menu = document.getElementById("contextMenu");
    menu.style.left = x + "px";
    menu.style.top = y + "px";
    menu.style.display = "block";
}

document.addEventListener("click", () => {
    document.getElementById("contextMenu").style.display = "none";
});

function ctxOpenChat(){
    window.open(`/inbox?phone=${selectedPhone}`, "_blank");
}

function ctxRetry(){
    retrySend(event, selectedWhatsappId);
}

function ctxMarkDelivered(){
    markDelivered(event, selectedWhatsappId);
}


// AUTO REFRESH
loadData();
setInterval(loadData, 20000);

</script>

</body>
</html>
