<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Web</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <style>
    /* LEGACY CHAT STYLE */
.chat-item.legacy {
    background: rgba(255,255,255,0.03);
    opacity: 0.75;
    border-left: 4px solid #888;
}

.chat-item.legacy:hover {
    background: rgba(255,255,255,0.05);
}

.legacy-badge {
    font-size: 10px;
    background: yellow;
    color: black;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 6px;
}

.msg.legacy {
    background-color: #2b2b2b;
    color: #bbb;
    border: 1px dashed #555;
    opacity: 0.8;
}

.msg.legacy::after {
    content: "OLD";
    font-size: 9px;
    margin-left: 6px;
    color: #999;
}

    /* Update Filter Badge Styling */
    /* Filter Bar Container */
    .filter-bar {
        padding: 8px 15px;
        display: flex;
        gap: 10px;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
        overflow-x: auto; /* Enable scrolling */
        white-space: nowrap;
    }
    .filter-bar::-webkit-scrollbar {
    height: 3px;            /* Slim scrollbar height */
    display: block;         /* Ensure it is visible */
}
.filter-bar::-webkit-scrollbar-track {
    background: transparent; /* Invisible track */
}

.filter-bar::-webkit-scrollbar-thumb {
    background: #37404a;    /* Dark Gray Handle */
    border-radius: 3px;     /* Rounded edges */
}

.filter-bar::-webkit-scrollbar-thumb:hover {
    background: #55606c;    /* Lighter on hover */
}

/* ðŸŸ¢ 3. FIREFOX SUPPORT */
.filter-bar {
    scrollbar-width: thin;  /* Thin scrollbar */
    scrollbar-color: #37404a transparent;
}
.modal div::-webkit-scrollbar {
  width: 6px;
}

.modal div::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.2);
  border-radius: 10px;
}
    /* Individual Filter Chip */
    .filter-chip {
        padding: 6px 12px;
        border-radius: 24px; /* Pill shape */
        background: #202c33; /* Dark gray */
        color: #8696a0;
        font-size: 13px;
        cursor: pointer;
        border: 1px solid #2a3942;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .filter-chip:hover {
        background: #2a3942;
    }

    /* Active State (Green) */
    .filter-chip.active {
        background: #00a884; /* WhatsApp Green */
        color: #111b21;      /* Dark Text */
        border-color: #00a884;
    }
    /*.filter-badge { background: var(--wati-green); color: black; border-radius: 50%; padding: 2px 6px; font-size: 10px; margin-left: 5px; font-weight: bold; display:inline; }

     The Count Bubble */
    .filter-badge {
        display: inline-flex;       /* ðŸŸ¢ Fixes visibility & alignment */

        background: var(--wati-green); /* Slightly lighter gray */
        color: black;
        border-radius: 50%;
        padding: 0 5px;
        min-width: 18px;
        height: 18px;
        font-size: 10px;
        font-weight: 600;
        align-items: center;
        justify-content: center;
    }

    /* Bubble color when Chip is Active */
    .filter-chip.active .filter-badge {
        background: #fff;    /* White bubble */
        color: #00a884;      /* Green text */
    }


    /* TAGS IN SIDEBAR */
.tag-container {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 2px;
}
.tag-pill {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    color: white;
    font-weight: bold;
    text-transform: uppercase;
}

/* TAG MODAL */
#tag-selection-area { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
.tag-choice {
    padding: 6px 12px;
    border: 1px solid #2a3942;
    border-radius: 15px;
    cursor: pointer;
    color: #d1d7db;
    transition: 0.2s;
}
.tag-choice:hover { background: #2a3942; }
.tag-choice.selected {
    border-color: transparent;
    color: #fff;
    /* Background set dynamically via JS based on tag color */
}



    .deleted-msg {
    display: inline-block;
    font-style: italic;
    font-size: 13px;
    color: #8696a0;
    padding: 6px 10px;
    background: #1f2c34;
    border-radius: 8px;
    animation: deletedFadeIn 180ms ease-out;
}

/* Smooth collapse animation */
.msg.deleted {
    animation: collapseMsg 160ms ease-out forwards;
}

/* Animations */
@keyframes deletedFadeIn {
    from {
        opacity: 0;
        transform: translateY(-2px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes collapseMsg {
    from {
        opacity: 1;
        max-height: 500px;
    }
    to {
        opacity: 1;
        max-height: 80px;
    }
}
    .menu-divider {
        height: 1px;
        background: #2a3942;
        margin: 6px 0;
    }

    .context-menu .danger {
        color: #f15c6d;
    }

    /* Overall composer */
    .composer {
        background: #1f2c34;
        padding: 8px;
        border-top: 1px solid #2a3942;
    }

    .reply-bar-container {
        width: 100%;
        box-sizing: border-box;
    }



    /* make reply UI inside the bar align and not overflow */
    .reply-ui { display:flex; align-items:center; gap:10px; }
    .reply-preview-text, .reply-preview { max-width: 100%; }
.reply-body {
    flex: 1;
    overflow: hidden;
}

.reply-name {
    font-size: 13px;
    font-weight: 600;
    color: #25D366;
}


.reply-close {
    cursor: pointer;
    font-size: 16px;
    color: #8696a0;
}

/* Input row */
.input-row {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #2a3942;
    border-radius: 8px;
    padding: 8px 10px;
}

.input-row input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: #e9edef;
    font-size: 14px;
}

.icon {
    cursor: pointer;
    color: #8696a0;
    font-size: 18px;
}

.icon.mic {
    font-size: 20px;
}


    .context-menu {
        position: absolute;
        background: #1f2c34;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        display: none;
        z-index: 9999;
        min-width: 140px;
    }

    .context-menu .menu-item {
        padding: 10px 14px;
        cursor: pointer;
        font-size: 14px;
    }

    .context-menu .menu-item:hover {
        background: #2a3942;
    }

    msg {
        position: relative;
    }

    /* Default (received messages) */
    .msg.received .msg-actions {
        position: absolute;
        top: 8px;
        right: -18px;
    }

    /* Sent messages (You) */
    .msg.sent .msg-actions {
        position: absolute;
        top: 8px;
        left: -18px;
    }

    .msg-actions {
        font-size: 14px;
        cursor: pointer;
        user-select: none;
        color: #8696a0;
        opacity: 1; /* always visible as you wanted */
    }


    .reply-preview {
    display: flex;
    cursor: pointer;
    margin-bottom: 4px;
    }

    .reply-bar {
        width: 3px;
        background: #25D366;
        margin-right: 6px;
        border-radius: 2px;
    }

    .reply-content {
        font-size: 12px;
        color: #8696a0;
    }

    .reply-author {
        font-weight: 600;
        color: #25D366;
        margin-bottom: 2px;
    }

    .reply-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .reply-thumb {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
    }
    .reply-highlight {
    animation: replyFlash 1.2s ease;
      }

      @keyframes replyFlash {
          0%   { background-color: rgba(37, 211, 102, 0.35); }
          100% { background-color: inherit; }
      }

    .date-divider {
      align-self: center;
      background: var(--system-msg-bg);
      color: var(--secondary-text);
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 8px;
      margin: 12px 0;
    }
    .reply-preview {
      border-left: 4px solid #00a884;
      background: rgba(255,255,255,0.06);
      padding: 6px 8px;
      margin-bottom: 6px;
      border-radius: 4px;
    }

    .reply-author {
      font-size: 12px;
      font-weight: 600;
      color: #00a884;
    }

    .reply-text {
      font-size: 12px;
      color: #d1d7db;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }


        :root {
            --bg-color: #0c1317; --sidebar-bg: #111b21; --header-bg: #202c33;
            --border-color: #2a3942; --incoming-bg: #202c33; --outgoing-bg: #005c4b;
            --primary-text: #e9edef; --secondary-text: #8696a0; --input-bg: #2a3942;
            --accent: #00a884; --system-msg-bg: #182229;
            --tick-gray: #8696a0; --tick-blue: #53bdeb;
            --wati-green: #25D366;
        }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #000; height: 100vh; overflow: hidden; color: var(--primary-text); }
        #app { display: flex; height: 100%; width: 100%; }

        .material-icons {
            font-family: 'Material Icons'; font-weight: normal; font-style: normal; font-size: 24px;
            display: inline-block; line-height: 1; text-transform: none; letter-spacing: normal;
            word-wrap: normal; white-space: nowrap; direction: ltr; -webkit-font-smoothing: antialiased;
        }

        #sidebar { width: 400px; display: flex; flex-direction: column; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); }
        .header { height: 60px; background: var(--header-bg); padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; }
        .my-avatar { width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center; cursor: pointer; color: white; font-weight: bold; font-size: 14px; background-color: #6a7f8a; }
        .icon-btn { color: #aebac1; cursor: pointer; padding: 8px; border-radius: 50%; display:flex; align-items:center; justify-content:center; }
        .icon-btn:hover { background: rgba(255,255,255,0.1); }

        .filter-bar { padding: 8px 15px; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid var(--border-color); }
        .filter-chip { padding: 5px 12px; border-radius: 20px; background: var(--header-bg); color: var(--secondary-text); font-size: 13px; cursor: pointer; border: 1px solid transparent; }
        .filter-chip.active { background: var(--accent); color: #fff; }
        /* Badge for filter chip*/

        .search-box { padding: 8px 12px; }
        .search-input { width: 100%; background: var(--header-bg); border: none; padding: 8px 30px 8px 15px; border-radius: 8px; color: #fff; outline: none; }

        #chat-list { flex: 1; overflow-y: auto; }
        .chat-item { display: flex; align-items: center; padding: 0 15px; height: 72px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .chat-item:hover { background: #202c33; }
        .chat-item.active { background: #2a3942; }
        .chat-avatar { width: 49px; height: 49px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 500; color: #fff; background-color: #6a7f8a; }
        .chat-info { flex: 1; margin-left: 15px; overflow: hidden; }
        .chat-top { display: flex; justify-content: space-between; margin-bottom: 3px; }
        .chat-name { font-size: 17px; color: var(--primary-text); }
        .chat-time { font-size: 12px; color: var(--secondary-text); }
        .chat-msg { font-size: 14px; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 5px;}
        .unread-badge { background: var(--accent); color: #111b21; font-size: 12px; font-weight: bold; border-radius: 50%; min-width: 20px; height: 20px; display: grid; place-items: center; padding: 0 4px;}

        #chat-view { flex: 1; display: flex; flex-direction: column; background: #0b141a; position: relative; }
        #chat-view::before { content: ''; position: absolute; width: 100%; height: 100%; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); opacity: 0.06; pointer-events: none; }
        .chat-header { height: 60px; background: var(--header-bg); padding: 0 16px; display: flex; align-items: center; z-index: 2; }

        .session-timer { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--wati-green); color: var(--wati-green); font-weight: bold; font-size: 11px; display: grid; place-items: center; margin-right: 15px; background: rgba(37, 211, 102, 0.1); cursor: help; }
        .session-expired { border-color: red; color: red; background: rgba(255,0,0,0.1); }

        #messages { flex: 1; overflow-y: auto; padding: 20px 5%; display: flex; flex-direction: column; z-index: 1; }
        .msg { max-width: 65%; padding: 6px 7px 8px 9px; margin-bottom: 4px; border-radius: 8px; position: relative; font-size: 14.2px; line-height: 19px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .msg.sent { align-self: flex-end; background: var(--outgoing-bg); border-top-right-radius: 0; }
        .msg.received { align-self: flex-start; background: var(--incoming-bg); border-top-left-radius: 0; }
        .msg-meta { float: right; margin-left: 10px; margin-top: 4px; font-size: 11px; color: rgba(255,255,255,0.6); display: flex; align-items: center; gap: 2px; }

        .tick { font-size: 16px; font-weight: bold; }
        .tick.sent { color: var(--tick-gray); }
        .tick.delivered { color: var(--tick-gray); }
        .tick.read { color: var(--tick-blue); }
        .phone-link { color: #53bdeb; cursor: pointer; text-decoration: none; font-weight: 500; }
        .phone-link:hover { text-decoration: underline; }

        .chat-media { max-width: 200px; max-height: 200px; width: auto; height: auto; object-fit: contain; border-radius: 6px; margin-top: 5px; cursor: pointer; background-color: rgba(0,0,0,0.1); }

        #footer {
            min-height: 62px;
            background: var(--header-bg);
            padding: 5px 16px;
            display: flex;
            align-items: flex-end; /* ðŸ”¥ KEY FIX */
            gap: 10px;
            z-index: 2;
            position: relative;
        }        .input-bar:disabled { opacity: 0.5; cursor: not-allowed; }
        .input-bar {
            flex: 1; background: var(--input-bg); border-radius: 8px; padding: 10px 12px; color: #fff; border: none; outline: none; font-size: 15px; font-family: inherit; resize: none; height: 42px; overflow-y: hidden;
        }

        .template-btn { background: var(--wati-green); color: white; border: none; padding: 8px 12px; border-radius: 5px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px; }
        .template-btn:hover { background: #1eac52; }

        emoji-picker { position: absolute; bottom: 70px; left: 20px; z-index: 100; --background: #111b21; --border-color: #2a3942; display: none; }
        .attach-menu { position: absolute; bottom: 70px; left: 50px; background: #233138; border-radius: 10px; display: none; flex-direction: column; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 100;}
        .attach-opt { padding: 12px 20px; display: flex; align-items: center; gap: 10px; cursor: pointer; color: #d1d7db; }
        .attach-opt:hover { background: #111b21; }

        .quick-reply-menu { position: absolute; bottom: 70px; left: 100px; background: #233138; border-radius: 10px; display: none; flex-direction: column; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 100; width: 250px; max-height: 300px; overflow-y: auto;}
        .qr-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #2a3942; color: #e9edef; font-size: 14px; }
        .qr-item:hover { background: #111b21; }
        .qr-item strong { color: var(--accent); display:block; font-size: 12px;}
        .qr-manage-btn { padding: 10px; text-align: center; background: #2a3942; color: var(--accent); cursor: pointer; font-weight: bold; font-size: 13px;}

        #slash-popup { position: absolute; bottom: 70px; left: 150px; background: #233138; border-radius: 8px; width: 300px; max-height: 250px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .slash-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #2a3942; }
        .slash-item:hover { background: #111b21; }
        .slash-shortcut { color: var(--accent); font-weight: bold; }

        .context-menu { display: none; position: absolute; z-index: 1000; background-color: var(--header-bg); border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); padding: 5px 0; width: 180px; }
        .context-menu-item { padding: 8px 15px; color: var(--primary-text); cursor: pointer; font-size: 14px; }
        .context-menu-item:hover { background-color: #2a3942; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; place-items: center; z-index: 200; }
        .modal { background: var(--header-bg); padding: 20px; border-radius: 10px; width: 450px; color: #fff; display: flex; flex-direction: column; gap: 15px; max-height: 80vh; }
        .modal h3 { margin: 0; }
        .modal input, .modal textarea { width: 100%; padding: 10px; background: var(--input-bg); border: none; color: #fff; border-radius: 5px; outline: none; font-family: inherit;}
        .modal-buttons { display:flex; justify-content:flex-end; gap:10px; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: var(--accent); color: #111b21; }
        .btn-sec { background: transparent; color: var(--accent); }

        #template-list, #qr-manage-list { overflow-y: auto; max-height: 300px; display: flex; flex-direction: column; gap: 10px; }
        .template-item, .qr-row { background: #111b21; padding: 10px; border-radius: 5px; cursor: pointer; border: 1px solid transparent; position: relative;}
        .template-item:hover { border-color: var(--accent); }
        .template-body { font-size: 12px; color: var(--secondary-text); margin-top: 5px; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4; }
        .qr-delete { position: absolute; right: 10px; top: 10px; color: red; cursor: pointer; display: none; }
        .qr-row:hover .qr-delete { display: block; }

        #preview-container { width: 100%; max-height: 300px; overflow: hidden; display: flex; justify-content: center; background: #000; border-radius: 5px;}
        #preview-img { max-width: 100%; max-height: 300px; object-fit: contain; }
        #preview-video { max-width: 100%; max-height: 300px; }
        #recording-ui { display: none; color: #f00; align-items: center; gap: 10px; flex: 1; }
        .rec-dot { width: 10px; height: 10px; background: red; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        #image-viewer { display: none; position: fixed; z-index: 3000; padding-top: 50px; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.9); cursor: zoom-out; justify-content: center; align-items: center; }
        #full-image { margin: auto; display: block; width: auto; height: auto; max-width: 90%; max-height: 90vh; object-fit: contain; animation-name: zoom; animation-duration: 0.3s; border-radius: 5px; box-shadow: 0 0 20px rgba(255,255,255,0.1); }
        #viewer-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; }
    </style>
</head>
<body>

<div id="app">
    <aside id="sidebar">
        <div class="header">
            <div class="my-avatar" id="my-avatar" title="My Profile"><span class="material-icons">person</span></div>
            <div style="display: flex; gap: 15px;">
                <span class="material-icons icon-btn" title="New Chat" onclick="showNewChatModal()">chat</span>
                <span class="material-icons icon-btn" title="Logout" onclick="window.location.href='/logout'">logout</span>
            </div>
        </div>
        <div class="filter-bar">
            <!-- Static Filters -->
            <div class="filter-chip active" onclick="setFilter('all', this)">All</div>
            <div class="filter-chip" onclick="setFilter('unread', this)">
                Unread <span id="filter-unread" class="filter-badge">0</span>
            </div>

            <!-- ðŸŸ¢ DYNAMIC TAGS CONTAINER -->
            <div id="tag-filters" style="display:flex; gap:10px;"></div>
        </div>


        <div class="search-box"><input type="text" class="search-input" placeholder="Search or start new chat" onkeyup="filterChats(this.value)"></div>
        <div id="chat-list"></div>
    </aside>

    <main id="chat-view">
        <div class="chat-header">
            <div class="session-timer" id="session-timer" title="Time remaining to reply">--</div>
            <div class="chat-avatar" id="header-avatar" style="width: 35px; height: 35px; font-size: 14px;"></div>
            <div class="chat-title" style="margin-left: 10px; display:flex; align-items:center; width:100%;">
                <div>
                    <div id="active-contact">Select a chat</div>
                    <div id="active-name" class="chat-subtitle"></div>
                </div>
                <!-- TAG BUTTON -->
                <span class="material-icons icon-btn" onclick="openTagModal()" title="Manage Tags"
                      style="margin-left: auto; color: var(--accent); display:none;" id="header-tag-btn">
                    label
                </span>
            </div>

        </div>
        <div id="messages">
            <div style="text-align: center; margin-top: 20%; color: var(--secondary-text);">
                <h2>WhatsApp Web</h2>
                <p>Send and receive messages without keeping your phone online.</p>
            </div>
        </div>
        <!-- ðŸŸ¢ AUTOMATION PREVIEW BANNER -->
        <div id="automation-banner"
             style="display:none; margin:8px 16px; padding:10px;
                    border:1px solid #2a3942;
                    background:#0f1f17;
                    border-radius:6px;">

            <div style="font-weight:600; margin-bottom:6px;">
                ðŸ¤– Automation suggestion
            </div>

            <div id="automation-text"
                 style="font-size:14px; color:#d1d7db; margin-bottom:8px;">
            </div>

            <div style="display:flex; gap:8px;">
                <button class="btn btn-primary" id="automation-send">
                    Send
                </button>
                <button class="btn btn-sec" id="automation-ignore">
                    Ignore
                </button>
            </div>
        </div>

        <footer id="footer">
            <span class="material-icons icon-btn" onclick="toggleEmoji()">sentiment_satisfied_alt</span>
            <span class="material-icons icon-btn"
                  onclick="console.log('ðŸ“Ž ATTACH CLICKED'); toggleAttach(event)">
              attach_file
            </span>
                        <span class="material-icons icon-btn" style="color: #FFC107;" title="Quick Reply" onclick="toggleQuickReplies()">flash_on</span>

            <!-- composer-wrapper holds reply bar ABOVE the input and stretches to fill footer -->
            <div class="composer-wrapper" style="flex:1; display:flex; flex-direction:column; gap:6px;">
                <div id="reply-bar" class="reply-bar-container" style="display:none; width:100%;"></div>

                <textarea
                    id="msg-input"
                    class="input-bar"
                    placeholder="Type a message (or / for replies)"
                    rows="1"
                    disabled>
                </textarea>
            </div>

            <button class="template-btn" onclick="openTemplateModal()">Template</button>
            <span class="material-icons icon-btn" id="send-btn" onclick="sendMessage()" style="display:none;">send</span>
            <span class="material-icons icon-btn" id="mic-btn" onclick="startRecording()">mic</span>
            <div id="recording-ui">
                <div class="rec-dot"></div><span id="rec-timer">0:00</span>
                <span class="material-icons icon-btn" style="color:red;" onclick="stopRecording(false)">delete</span>
                <span class="material-icons icon-btn" style="color:var(--accent);" onclick="stopRecording(true)">send</span>
            </div>
        <emoji-picker></emoji-picker>
            <div class="attach-menu" id="attach-menu">
                <div class="attach-opt" onclick="triggerUpload('image')"><span class="material-icons" style="color:#d3396d;">image</span> Photos & Videos</div>
                <div class="attach-opt" onclick="triggerUpload('document')"><span class="material-icons" style="color:#5f66cd;">description</span> Document</div>
            </div>
            <div class="quick-reply-menu" id="quick-reply-menu">
                <div id="qr-list-content"></div> <!-- ðŸ”¥ REQUIRED -->
                <div class="qr-manage-btn" onclick="openManageQRModal()">Manage replies</div>
            </div>
                        <div id="slash-popup"></div>
        </footer>
    </main>
</div>

<div id="context-menu" class="context-menu">
    <div class="context-menu-item" onclick="markChatUnread()">Mark as unread</div>
</div>
<div id="image-viewer" onclick="closeImageViewer()">
    <span id="viewer-close" onclick="closeImageViewer()">&times;</span>
    <img id="full-image">
</div>

<div class="modal-overlay" id="new-chat-modal">
    <div class="modal">
        <h3>New Chat</h3>
        <input type="text" id="new-phone" placeholder="Phone Number">
        <div class="modal-buttons"><button class="btn btn-sec" onclick="closeModal('new-chat-modal')">Cancel</button><button class="btn btn-primary" onclick="startNewChat()">Start Chat</button></div>
    </div>
</div>
<div class="modal-overlay" id="preview-modal">
    <div class="modal">
        <h3>Send File</h3>
        <div id="preview-container"></div>
        <div id="preview-filename" style="font-size:12px; color:#aaa; margin-top:5px;"></div>
        <input type="text" id="file-caption" placeholder="Add a caption...">
        <div class="modal-buttons"><button class="btn btn-sec" onclick="cancelUpload()">Cancel</button><button class="btn btn-primary" onclick="confirmUpload()">Send</button></div>
    </div>
</div>
<div class="modal-overlay" id="template-modal">
    <div class="modal" style="width: 500px;">
        <h3>Select Template</h3>
        <input type="text" id="template-search" placeholder="Search templates..." onkeyup="filterTemplates()">
        <div id="template-list"></div>
        <div class="modal-buttons"><button class="btn btn-sec" onclick="closeModal('template-modal')">Cancel</button></div>
    </div>
</div>
<div class="modal-overlay" id="manage-qr-modal">
    <div class="modal" style="width: 600px;">
        <h3>Manage Quick Replies</h3>
        <div style="display:flex; flex-direction: column; gap:10px;">
            <input type="hidden" id="qr-id">
            <div style="display: flex; gap: 10px;">
                <input type="text" id="new-qr-shortcut" placeholder="Shortcut (e.g. intro)" style="width:30%;">
                <textarea id="new-qr-msg" rows="3" placeholder="Full message..." style="flex:1;"></textarea>
            </div>
            <div style="display:flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-sec" onclick="resetQRForm()" id="qr-cancel-btn" style="display:none;">Cancel Edit</button>
                <button class="btn btn-primary" onclick="saveQuickReply()" id="qr-save-btn">Add Reply</button>
            </div>
        </div>
        <div id="qr-manage-list" style="margin-top:15px; border-top:1px solid #333; padding-top:10px;"></div>
        <div class="modal-buttons"><button class="btn btn-sec" onclick="closeModal('manage-qr-modal')">Close</button></div>
    </div>
</div>
<input type="file" id="hidden-file-input" style="display:none;">
<div id="msg-context-menu" class="context-menu">

    <div class="menu-item" data-action="reply">Reply</div>
    <div class="menu-item" data-action="forward">Forward</div>

    <div class="menu-divider"></div>

    <div class="menu-item retry-item" data-action="retry">Retry Media</div>

    <div class="menu-divider"></div>

    <div class="menu-item" data-action="delete-me">Delete for me</div>

</div>


<div class="modal-overlay" id="tag-modal">
    <div class="modal">
        <h3>Manage Tags</h3>
        <input type="text" id="new-tag-name" placeholder="Create new tag..." style="margin-bottom:10px;">
        <button class="btn btn-sec" onclick="createNewTag()" style="margin-bottom:15px; width:100%;">+ Create Tag</button>

        <div id="tag-selection-area">Loading tags...</div>

        <div class="modal-buttons" style="margin-top:20px;">
            <button class="btn btn-primary" onclick="closeModal('tag-modal')">Done</button>
        </div>
    </div>
</div>
<!-- ðŸŸ¢ NEW: VARIABLE INPUT MODAL -->
<div class="modal-overlay" id="variable-modal">
  <div class="modal" style="width:400px; max-height:85vh; display:flex; flex-direction:column;">
        <h3>Fill Template Details</h3>
        <h3>Fill Template Details</h3>

        <div style="overflow-y:auto; padding-right:5px; flex:1;">

            <p id="var-template-preview"
               style="font-size:12px; color:#8696a0; margin-bottom:15px; font-style:italic;">
            </p>

            <!-- Order Selector -->
            <div id="order-selector" style="display:none; margin-bottom:12px;">
                <label style="font-size:12px; font-weight:bold; color:#00a884;">
                    Select Order
                </label>
                <select id="order-select"
                    style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd;">
                </select>
            </div>

            <!-- Inputs -->
            <div id="variable-inputs-container"
                 style="display:flex; flex-direction:column; gap:10px;">
            </div>

        </div>


        <div class="modal-buttons" style="margin-top:20px;">
            <button class="btn btn-sec" onclick="closeModal('variable-modal')">Cancel</button>
            <button class="btn btn-primary" onclick="submitTemplateVariables()">Send Now</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. GLOBAL VARIABLES & STATE
    // ==========================================

    let currentPhone = null;
    let availableTags = [];
    let taggingPhone = null;
    let lastTagInteraction = 0;
    let pendingTemplateData = null; // Stores info while filling variables

    let lastTagStateSignature = "";
    let currentChatContext = {
        name: null,
        order_code: null,
        order_candidates: []
    };

    // TIMERS
    let chatLoopTimer = null;
    let chatListTimer = null;
    let chatHistoryTimer = null;
    let chatAbortController = null;

    // STATE
    let lastRenderChecksum = "";
    let lastRenderedMessages = [];
    let lastRenderedCount = 0;

    // FLAGS
    const messageById = new Map();
    let locallyMarkedUnread = new Set();
    let isSending = false;
    let isNavigatingToReply = false;
    let lastUserMsgTime = null;
    let initialAutoSelectDone = false;

    // MESSAGING
    let replyTarget = null;

    // UPLOADS & MEDIA
    let mediaRecorder = null;
    let audioChunks = [];
    let recStartTime = null;
    let recTimerInt = null;
    let pendingFile = null;
    let pendingFileType = null;

    // DATA
    let allChats = [], allTemplates = [], quickReplies = [];
    let currentFilter = 'all';

    // DOM ELEMENTS (Loaded later)
    let msgInputEl, captionInputEl;
    async function loadGlobalTags() {
        try {
            const r = await fetch('/tags');
            availableTags = await r.json();
            // We don't render here anymore,
            // because renderTagFilters() inside renderChatList() will do it.
        } catch(e) { console.error(e); }
    }


    // --- INITIALIZATION ---
    document.addEventListener("DOMContentLoaded", () => {
        msgInputEl = document.getElementById('msg-input');
        captionInputEl = document.getElementById('file-caption');

        loadMyProfile();
        loadQuickReplies();
        loadChats();
        chatListTimer = setInterval(loadChats, 4000);
        loadGlobalTags();

        // Event Listeners
        if(msgInputEl) {
            msgInputEl.addEventListener('input', function(e) {
                checkInput();
                if (this.value.includes('/')) showSlashPopup(this.value.split('/').pop());
                else document.getElementById('slash-popup').style.display = 'none';
            });
            msgInputEl.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            });
            msgInputEl.addEventListener('paste', handlePaste);
        }

        if(captionInputEl) {
            captionInputEl.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') { e.preventDefault(); confirmUpload(); }
            });
        }

        document.querySelector('emoji-picker').addEventListener('emoji-click', e => {
            msgInputEl.value += e.detail.unicode; toggleEmoji(); msgInputEl.focus(); checkInput();
        });

        // Close menus on click outside
        window.onclick = function(e) {
            if (!e.target.matches('.msg-actions')) document.getElementById('msg-context-menu').style.display='none';
            document.addEventListener('click', function () {
                const menu = document.getElementById('context-menu');
                if (menu) menu.style.display = 'none';
            });
            if (!e.target.closest('.attach-menu') && !e.target.closest('.icon-btn')) document.getElementById('attach-menu').style.display='none';
        }
    });

    // ==========================================
    // 2. CORE CHAT FUNCTIONS
    // ==========================================

    async function chatLoop() {
        if (!currentPhone) return;
        await refreshChat(false);
        if (currentPhone) {
            chatLoopTimer = setTimeout(chatLoop, 3000);
        }
    }

    let orderContextLoading = false;


    async function openChat(phone, name) {

        // ================= RESET CONTEXT =================
        currentChatContext.name = name || null;
        currentChatContext.order_code = null;
        currentChatContext.order_candidates = [];
        currentChatContext.cod_value = null;   // âœ… ADD

        // =================================================

        if (currentPhone === phone) return;

        // ================= LOAD ORDER DATA =================
        orderContextLoading = true;

        fetch(`/last_orders?phone=${phone}`)
            .then(r => r.ok ? r.json() : null)
            .then(d => {

                console.log("LAST_ORDERS RESPONSE:", d);

                if (!d || !d.orders || d.count === 0) return;

                // âœ… Always auto-pick latest order
                currentChatContext.order_code = d.orders[0].order_code;

                // âœ… Name fallback from Lifafay
                if (
                    (!currentChatContext.name || currentChatContext.name.trim() === "") &&
                    d.orders[0].customer_name
                ) {
                    currentChatContext.name = d.orders[0].customer_name;
                }
                currentChatContext.cod_value = d.orders[0].cod_value || null;

                // âœ… Show dropdown if multiple orders
                if (d.count > 1) {
                    populateOrderDropdown(d.orders);
                } else {
                    document.getElementById("order-selector").style.display = "none";
                }

                console.log("FINAL CHAT CONTEXT:", currentChatContext);
            })
            .catch(err => console.error("Order fetch failed:", err))
            .finally(() => {
                orderContextLoading = false;
            });

        // ====================================================

        // 1. Kill old processes
        if (chatLoopTimer) { clearTimeout(chatLoopTimer); chatLoopTimer = null; }
        if (chatHistoryTimer) { clearInterval(chatHistoryTimer); chatHistoryTimer = null; }
        if (chatAbortController) { chatAbortController.abort(); }

        document.getElementById('header-tag-btn').style.display = 'block';

        // 2. Reset State
        const newUrl = `${window.location.pathname}?phone=${phone}`;
        window.history.pushState({ path: newUrl }, '', newUrl);

        currentPhone = phone;
        lastRenderChecksum = "";
        isSending = false;

        // 3. UI Updates
        document.querySelectorAll('.chat-item').forEach(e => e.classList.remove('active'));

        const activeItem = document.getElementById(`chat-item-${phone}`);
        if (activeItem) {
            activeItem.classList.add('active');
            const b = activeItem.querySelector('.unread-badge');
            if (b) b.remove();
        }

        document.getElementById('active-contact').innerText = name || phone;
        document.getElementById('active-name').innerText = name ? phone : '';

        const h = document.getElementById('header-avatar');
        h.style.backgroundColor = getAvatarColor(phone);
        h.innerText = name ? getInitials(name) : '?';

        if (activeItem && activeItem.classList.contains("legacy")) {
            msgInputEl.disabled = true;
            msgInputEl.placeholder = "This is an archived chat (old WhatsApp account)";
        } else {
            msgInputEl.disabled = false;
            msgInputEl.placeholder = "Type a message";
        }
        msgInputEl.focus();

        document.getElementById('messages').innerHTML =
            '<div style="text-align:center;padding:50px;color:#8696a0;">Loading messages...</div>';

        // 4. Mark Read
        locallyMarkedUnread.delete(phone);
        fetch('/mark_read', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone })
        }).catch(() => {});

        // 5. Start chat polling
        await refreshChat(true);
        chatLoop();
    }
    function populateOrderDropdown(orders) {

        const box = document.getElementById("order-selector");
        const select = document.getElementById("order-select");

        if (!box || !select) return;

        select.innerHTML = "";

        orders.forEach((o, idx) => {

            const d = new Date(o.order_date);
            const label = `${o.order_code} â€” ${d.toLocaleDateString()}`;

            const opt = document.createElement("option");
            opt.value = o.order_code;
            opt.textContent = label;

            if (idx === 0) opt.selected = true;

            select.appendChild(opt);
        });

        // Show selector
        box.style.display = "block";

        // --- IMPORTANT FIX ---
        select.onchange = () => {

            const selectedCode = select.value;

            // Update context
            currentChatContext.order_code = selectedCode;

            // Update Variable {{2}} input field if exists
            const var2Input = document.querySelector(
                '#variable-inputs-container input[data-index="2"]'
            );

            if (var2Input) {
                var2Input.value = selectedCode;
            }

            console.log("Order changed:", selectedCode);
        };
    }

    async function refreshChat(forceScroll = false) {
            const phoneAtStart = currentPhone;
            if (!phoneAtStart || isSending) return;

            if (chatAbortController) chatAbortController.abort();
            chatAbortController = new AbortController();

            let msgs;
            try {
                const resp = await fetch(`/history?phone=${phoneAtStart}`, { signal: chatAbortController.signal });
                if (!resp.ok) return;
                const ct = resp.headers.get('content-type') || '';
                if (!ct.includes('application/json')) return;
                msgs = await resp.json();
            } catch (e) { return; }

            if (phoneAtStart !== currentPhone) return;
            if (!Array.isArray(msgs)) return;

            msgs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            // OPTIMIZATION
            const count = msgs.length;
            const lastMsg = count > 0 ? msgs[count - 1] : null;
            const currentChecksum = `${count}-${lastMsg ? lastMsg.id : '0'}-${lastMsg ? lastMsg.status : 'n'}`;

            if (!forceScroll && currentChecksum === lastRenderChecksum) return;

            lastRenderChecksum = currentChecksum;
            lastRenderedMessages = msgs;
            lastRenderedCount = count;

            const container = document.getElementById('messages');
            const isAtBottom = (container.scrollHeight - container.scrollTop - container.clientHeight) < 150;
            const frag = document.createDocumentFragment();

            const banner = document.createElement('div');
            banner.style.cssText = 'text-align:center;margin:20px;color:#8696a0;font-size:12px;';
            banner.innerHTML = '<span class="material-icons" style="font-size:12px;">lock</span> Messages are end-to-end encrypted.';
            frag.appendChild(banner);

            let lastRenderedDate = null;
            lastUserMsgTime = null;
            messageById.clear();

            for (const m of msgs) {
                // Date Divider
                const msgDate = new Date(m.timestamp).toDateString();
                if (msgDate !== lastRenderedDate) {
                    const divider = document.createElement('div');
                    divider.className = 'date-divider';
                    const today = new Date().toDateString();
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    if (msgDate === today) divider.innerText = 'Today';
                    else if (msgDate === yesterday) divider.innerText = 'Yesterday';
                    else divider.innerText = new Date(m.timestamp).toLocaleDateString(undefined, { day: '2-digit', month: 'short', year: 'numeric' });
                    frag.appendChild(divider);
                    lastRenderedDate = msgDate;
                }

                const isSent = m.sender === 'agent';
                if (!isSent) {
                    const ts = parseServerTimestamp(m.timestamp);
                    if (!lastUserMsgTime || ts > lastUserMsgTime) lastUserMsgTime = ts;
                }

                const div = document.createElement('div');
                div.className = `msg ${isSent ? 'sent' : 'received'}`;

                // ðŸŸ¤ LEGACY MESSAGE VISUAL TAG
                if (m.is_legacy === true) {
                    div.classList.add('legacy');
                }


                // ðŸ”¥ ADDED: Set title attribute for hover effect
                if (m.intent && m.intent !== 'unknown') {
                    div.title = `Intent: ${m.intent}`;
                }

                if (m.id) {
                    div.dataset.msgId = m.id;
                    messageById.set(String(m.id), m);
                }
                if (m.whatsapp_id) div.dataset.wamid = m.whatsapp_id;

                // Reply UI
                let replyHtml = '';
                if (m.reply_to) {
                    let pt = m.reply_to.message ? m.reply_to.message.substring(0, 80) : (m.reply_to.media_type ? `[${m.reply_to.media_type}]` : 'Message');
                    let thumb = '';
                    if (['image','video'].includes(m.reply_to.media_type) && m.reply_to.media_id) {
                        thumb = `<img src="/media/${m.reply_to.media_id}" class="reply-thumb" loading="lazy" onerror="this.style.display='none'">`;
                    }
                    replyHtml = `<div class="reply-preview" data-reply-id="${m.reply_to.whatsapp_id||''}"><div class="reply-bar"></div><div class="reply-content"><div class="reply-author">${m.reply_to.sender==='agent'?'You':'User'}</div><div class="reply-row">${thumb}<div class="reply-text">${pt}</div></div></div></div>`;
                }

                // Content
                let content = '';
                if (m.deleted_for_me || m.deleted_for_everyone) {
                    div.classList.add('deleted');
                    content = `<div class="deleted-msg">${m.sender === 'agent' ? 'You deleted this message' : 'This message was deleted'}</div>`;
                } else if (m.media_id) {
                    if (['audio','voice'].includes(m.media_type)) content = `<audio controls preload="none"><source src="/media/${m.media_id}"></audio>`;
                    else if (m.media_type === 'video') content = `<video class="chat-media" controls src="/media/${m.media_id}"></video>`;
                    else if (m.media_type === 'document') content = `<div style="padding:10px;"><a href="/media/${m.media_id}" target="_blank" style="text-decoration:none;color:white;">ðŸ“„ Download Document</a></div>`;
                    else content = `<img src="/media/${m.media_id}" class="chat-media" loading="lazy" onclick="openImageViewer(this.src)">`;

                    if (m.message && !['audio','voice'].includes(m.media_type)) content += `<div style="margin-top:5px;">${linkify(m.message)}</div>`;
                } else {
                    content = linkify(m.message || '');
                }

                const time = new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const tickHtml = isSent ? getTickHtml(m.status) : '';
                const arrowHtml = !(m.deleted_for_me || m.deleted_for_everyone) ? '<span class="msg-actions" onclick="openContextMenu(event,this)">â–¾</span>' : '';

                div.innerHTML = `${arrowHtml}${replyHtml}${content}<div class="msg-meta">${time} ${tickHtml}</div>`;
                frag.appendChild(div);
            }

            container.replaceChildren(frag);

            if ((forceScroll || isAtBottom) && !isNavigatingToReply) {
                container.scrollTop = container.scrollHeight;
            }
            updateSessionTimer();

            // ðŸŸ¢ AUTOMATION PREVIEW (AFTER MESSAGES RENDER)
            if (
                lastMsg &&
                lastMsg.sender === "customer" &&
                lastMsg.message
            ) {
                fetch("/automation/preview", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: lastMsg.message
                    })
                })
                .then(r => r.json())
                .then(preview => {
                    if (preview && preview.intent) {
                        showAutomationBanner(preview);
                    } else {
                        hideAutomationBanner();
                    }
                })
                .catch(() => hideAutomationBanner());
            } else {
                hideAutomationBanner();
            }

        }
    // ==========================================
    // 3. ACTION HANDLERS
    // ==========================================

    async function sendMessage() {
        const txt = msgInputEl.value.trim();
        if (!txt || !currentPhone) return;

        isSending = true;
        if (chatLoopTimer) clearTimeout(chatLoopTimer);

        msgInputEl.value = '';
        checkInput();

        const container = document.getElementById('messages');

        let replyHtml = '';
        if (replyTarget) {
             let pt = replyTarget.message ? replyTarget.message.substring(0,80) : 'Attachment';
             replyHtml = `<div class="reply-preview"><div class="reply-bar"></div><div class="reply-content"><div class="reply-author">${replyTarget.sender==='agent'?'You':'User'}</div><div class="reply-text">${pt}</div></div></div>`;
        }

        container.insertAdjacentHTML('beforeend', `<div class="msg sent">${replyHtml}${linkify(txt)}<div class="msg-meta">Now ${getTickHtml('sent')}</div></div>`);
        container.scrollTop = container.scrollHeight;

        try {
            const payload = { phone: currentPhone, text: txt };
            if (replyTarget && replyTarget.whatsapp_id) payload.reply_to = replyTarget.whatsapp_id;
            clearReplyTarget();
            await fetch('/send_text', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        } catch (e) { console.error('Send failed', e); }

        setTimeout(() => {
            isSending = false;
            lastRenderChecksum = "";
            refreshChat(false);
            chatLoop();
        }, 1000);
    }

    async function confirmUpload() {
        if (!isSessionActive()) { alert("Session expired."); cancelUpload(); return; }
        if (!pendingFile) return;

        // Stop the background loop to prevent conflicts during upload
        if (chatLoopTimer) clearTimeout(chatLoopTimer);

        const cap = document.getElementById('file-caption').value;
        const fd = new FormData();
        fd.append('phone', currentPhone);
        fd.append('file', pendingFile);
        fd.append('type', pendingFileType);
        fd.append('caption', cap);

        document.getElementById('preview-modal').style.display = 'none';

        isSending = true;
        const tempId = 'temp-upload';
        document.getElementById('messages').insertAdjacentHTML('beforeend', `<div class="msg sent" id="${tempId}"><div style="font-style:italic;">â³ Uploading...</div></div>`);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;

        try {
            await fetch('/send_attachment', { method: 'POST', body: fd });
        } catch (e) { alert("Upload error"); }
        finally {
            pendingFile = null;
            document.getElementById('hidden-file-input').value = "";
            const t = document.getElementById(tempId); if(t) t.remove();

            isSending = false;
            lastRenderChecksum = "";
            await refreshChat(true);
            chatLoop(); // Restart the background loop
        }
    }


    // ==========================================
    // 4. HELPERS
    // ==========================================

    async function loadChats() {
      if (Date.now() - lastTagInteraction < 3000) {
          return;
      }
        if (document.querySelector('.search-input').value.trim() !== "") return;
        try {
            const resp = await fetch('/list_users');
            allChats = await resp.json();
            renderChatList();

            if (!initialAutoSelectDone) {
                initialAutoSelectDone = true;
                const params = new URLSearchParams(window.location.search);
                const targetPhone = params.get('phone');
                if (targetPhone) {
                    const existing = allChats.find(c => c.phone === targetPhone);
                    setTimeout(() => openChat(targetPhone, existing?existing.name:null), 100);
                }
            }
        } catch(e) { console.error(e); }
    }

    function renderChatList() {
      const list = document.getElementById('chat-list');

      // 1. Update Global Unread Badge
      const totalUnread = allChats.filter(c => (c.unread_count || 0) > 0).length;
      const badgeEl = document.getElementById('filter-unread');
      if (badgeEl) {
          badgeEl.innerText = totalUnread;
          badgeEl.style.display = totalUnread > 0 ? 'inline-block' : 'none';
      }

      // ðŸŸ¢ 2. REFRESH TAG COUNTS HERE
      // This ensures that as soon as chats load, the bubbles update
      if (Date.now() - lastTagInteraction > 3000) {
          renderTagFilters();
      }

      // 3. Filter Logic (Standard)
      const filtered = allChats.filter(c => {

          const unread = (c.unread_count || 0) > 0;
          const tags = (c.tags || []).map(t => t.name);

          const isUntagged = tags.length === 0;

          const isSpecialTag =
              tags.includes("Follow Up") ||
              tags.includes("Update Bill") ||
              tags.includes("Returns");

          // ðŸ”¹ UNREAD FILTER
          if (currentFilter === 'unread') {
              return unread;
          }

          // ðŸ”¹ ALL FILTER
          if (currentFilter === 'all') {
              return true;
          }

          // ðŸ”¹ UNTAGGED FILTER (this is 'none' in your app)
          if (currentFilter === 'none') {

              const tagNames = (c.tags || []).map(t => t.name);
              const hasUnread = (c.unread_count || 0) > 0;

              const isUntagged = tagNames.length === 0;

              const isFollowUp = tagNames.includes("Follow Up");
              const isUpdateBill = tagNames.includes("Update Bill");
              const isReturns = tagNames.includes("Returns");

              return (
                  (isUntagged && hasUnread) ||
                  isFollowUp ||
                  isUpdateBill ||
                  (isReturns && hasUnread)
              );
          }

          // ðŸ”¹ NORMAL TAG FILTER
          if (tags.includes(currentFilter)) {
              return true;
          }

          return false;
      });

      list.innerHTML = "";

      // 4. Render Rows
      filtered.forEach((c) => {
          let tagsHtml = '';
          if (c.tags && c.tags.length > 0) {
              tagsHtml = `<div class="tag-container" style="margin-top:2px;">` +
                         c.tags.map(t => `<span class="tag-pill" style="background:${t.color}">${t.name}</span>`).join('') +
                         `</div>`;
          }

          const isLocallyUnread = locallyMarkedUnread.has(c.phone);
          const unreadCount = isLocallyUnread ? Math.max(1, c.unread_count || 0) : (c.unread_count || 0);
          const unreadHtml = unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : '';
          const timeStr = c.last_ts ? new Date(c.last_ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
          const previewMsg = c.media_type ? `ðŸ“· ${c.media_type}` : (c.last_message || '');
          const bg = getAvatarColor(c.phone);
          const ini = c.name ? getInitials(c.name) : "?";

          const div = document.createElement('div');
          div.id = `chat-item-${c.phone}`;
          const legacyClass = c.is_legacy ? 'legacy' : '';
          div.className = `chat-item ${legacyClass} ${currentPhone === c.phone ? 'active' : ''}`;
          div.dataset.phone = c.phone; // <--- THIS LINE WAS MISSING

          div.onclick = () => openChat(c.phone, c.name);

          div.innerHTML = `
              <div class="chat-avatar" style="background-color:${bg};">${ini}</div>
              <div class="chat-info">
                  <div class="chat-top">
                      <div style="display:flex; align-items:center; gap: 6px; overflow:hidden;">
                      <span class="chat-name">
                        ${c.name||c.phone}
                        ${c.is_legacy ? '<span class="legacy-badge">OLD</span>' : ''}
                      </span>
                          <span class="material-icons"
                                style="font-size: 16px; color: #8696a0; cursor: pointer; opacity: 0.8;"
                                title="Manage Tags"
                                onmouseover="this.style.color='#00a884'"
                                onmouseout="this.style.color='#8696a0'"
                                onclick="event.stopPropagation(); openTagModal('${c.phone}')">
                              label
                          </span>
                      </div>
                      <span class="chat-time">${timeStr}</span>
                  </div>
                  <div class="chat-top">
                      <div style="overflow:hidden; flex:1;">
                          <span class="chat-msg">${previewMsg}</span>
                          ${tagsHtml}
                      </div>
                      ${unreadHtml}
                  </div>
              </div>`;
          list.appendChild(div);
      });
  }




    // --- UTILS ---
    function checkInput() {
        const val = msgInputEl.value.trim();
        document.getElementById('send-btn').style.display = val ? 'block' : 'none';
        document.getElementById('mic-btn').style.display = val ? 'none' : 'block';
    }
    function updateSessionTimer() {
        const t = document.getElementById('session-timer');
        if (!lastUserMsgTime) { t.innerText="--"; msgInputEl.disabled=true; msgInputEl.placeholder="24h session expired"; return; }
        const r = (24*3600*1000)-(new Date()-lastUserMsgTime);
        if(r>0){
            const h=Math.floor(r/3600000); const m=Math.floor((r%3600000)/60000);
            t.innerText=`${h}:${m<10?'0'+m:m}`; t.classList.remove('session-expired');
            msgInputEl.disabled=false; msgInputEl.placeholder="Type a message";
        } else {
            t.innerText="00:00"; t.classList.add('session-expired');
            msgInputEl.disabled=true; msgInputEl.placeholder="Send a template.";
        }
    }
    function handlePaste(e) {
        if (!isSessionActive()) { alert("Session expired."); e.preventDefault(); return; }
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.kind === 'file') {
                const blob = item.getAsFile();
                if (blob.type.startsWith('image/') || blob.type.startsWith('video/')) {
                    prepareUpload(blob, blob.type.startsWith('video') ? 'video' : 'image');
                    e.preventDefault();
                }
            }
        }
    }
    function setReplyTarget(m) { replyTarget = { whatsapp_id: m.whatsapp_id, sender: m.sender, message: m.message, media_type: m.media_type }; showReplyBar(replyTarget); msgInputEl.disabled=false; msgInputEl.focus(); }
    function showReplyBar(rt) { const bar = document.getElementById('reply-bar'); let pt = rt.message ? rt.message.substring(0,80) : (rt.media_type || 'Message'); bar.innerHTML = `<div class="reply-ui"><div class="reply-body"><div class="reply-name">${rt.sender==='agent'?'You':'User'}</div><div class="reply-text">${pt}</div></div><div class="reply-close" onclick="clearReplyTarget()">âœ•</div></div>`; bar.style.display = 'block'; }
    function clearReplyTarget() { replyTarget=null; document.getElementById('reply-bar').style.display='none'; }
    function findMessageByWamid(id) { return lastRenderedMessages.find(m => m.whatsapp_id === id); }
    function parseServerTimestamp(ts) { if (ts && ts.includes(" ")) ts = ts.replace(" ", "T") + "Z"; return new Date(ts); }
    function within24Hours(d) { if (!d) return false; return (Date.now() - d.getTime()) <= (86400000); }
    function isSessionActive() { return lastUserMsgTime && within24Hours(lastUserMsgTime); }
    function getAvatarColor(key) { if(!key) return '#607D8B'; const colors=['#F44336','#E91E63','#9C27B0','#673AB7','#3F51B5','#2196F3','#009688','#4CAF50','#FF9800','#FF5722','#795548','#607D8B']; let h=0; for(let i=0;i<key.length;i++) h=key.charCodeAt(i)+((h<<5)-h); return colors[Math.abs(h)%colors.length]; }
    function getInitials(name) { if (!name) return "?"; const p=name.trim().split(" "); return p.length>=2?(p[0][0]+p[p.length-1][0]).toUpperCase():p[0][0].toUpperCase(); }
    function getTickHtml(s) { if(!s)return''; let c='sent',i='done'; if(s==='delivered'){c='delivered';i='done_all';}else if(s==='read'){c='read';i='done_all';} return `<span class="material-icons tick ${c}">${i}</span>`; }
    function linkify(t) { if(!t)return""; let f=t.replace(/\n/g,'<br>'); return f.replace(/(?:\+|00|0)(?:92|3)\d{9,13}/g, m=>`<span class="phone-link" onclick="openChat('${m.replace(/\D/g,'')}',null)">${m}</span>`); }
    function openImageViewer(src) { document.getElementById('full-image').src=src; document.getElementById('image-viewer').style.display='flex'; }
    function closeImageViewer() { document.getElementById('image-viewer').style.display='none'; }

    // --- TEMPLATES & QR ---
    async function loadMyProfile() { try { const r=await fetch('/me'); if(r.ok){ const d=await r.json(); document.getElementById('my-avatar').innerText=getInitials(d.username); } } catch(e){} }
    async function loadQuickReplies() { try { const r=await fetch('/quick_replies'); quickReplies=await r.json(); } catch(e){} }
    function toggleQuickReplies() { const m=document.getElementById('quick-reply-menu'); m.style.display = m.style.display==='flex'?'none':'flex'; if(m.style.display==='flex') renderQuickReplyMenu(); }
    function renderQuickReplyMenu() { const l=document.getElementById('qr-list-content'); l.innerHTML = quickReplies.length===0?'No replies.':''; quickReplies.forEach(qr=>{ const d=document.createElement('div'); d.className='qr-item'; d.innerHTML=`<strong>/${qr.shortcut}</strong> ${qr.message.substring(0,40)}...`; d.onclick=()=>insertQuickReply(qr.message); l.appendChild(d); }); }
    function insertQuickReply(m) { msgInputEl.value=m; msgInputEl.focus(); checkInput(); document.getElementById('quick-reply-menu').style.display='none'; }
    function showSlashPopup(q) { const p=document.getElementById('slash-popup'); const f=quickReplies.filter(qr=>qr.shortcut.toLowerCase().includes(q.toLowerCase())); if(f.length===0){p.style.display='none';return;} p.innerHTML=''; f.forEach(qr=>{ const d=document.createElement('div'); d.className='slash-item'; d.innerHTML=`<span class="slash-shortcut">/${qr.shortcut}</span> ${qr.message.substring(0,50)}`; d.onclick=()=>{ msgInputEl.value=msgInputEl.value.substring(0,msgInputEl.value.lastIndexOf('/'))+qr.message; p.style.display='none'; msgInputEl.focus(); checkInput(); }; p.appendChild(d); }); p.style.display='block'; }

    async function openTemplateModal() { document.getElementById('template-modal').style.display = 'grid'; const l = document.getElementById('template-list'); l.innerHTML = 'Loading...'; try { const r = await fetch('/template_aliases'); const d = await r.json(); allTemplates = d.filter(t => t.visible_in_ui === true); renderTemplates(allTemplates); } catch (e) { l.innerHTML = 'Error loading templates'; } }
    function renderTemplates(templates) {
        const list = document.getElementById('template-list');
        list.innerHTML = '';
        if (!templates || templates.length === 0) {
            list.innerHTML = '<div style="padding:10px;color:#8696a0;">No templates found</div>';
            return;
        }
        templates.forEach(t => {
            const div = document.createElement('div');
            div.className = 'template-item';
            let preview = (t.preview_text || '').split('\n').slice(0, 4).join('<br>');
            div.innerHTML = `<div class="template-name">${t.internal_name}</div><div class="template-body">${preview}</div>`;

            // ðŸ”¥ CHANGED: Call checkVariables instead of send directly
            div.onclick = () => checkTemplateVariables(t.meta_template_name, t.language_code, t.preview_text || '');
            list.appendChild(div);
        });
    }

    function checkTemplateVariables(name, lang, bodyText) {
      if (orderContextLoading) {
      alert("Loading order details... please wait");
      return;
      }
        const regex = /\{\{(\d+)\}\}/g;
        const matches = [...bodyText.matchAll(regex)];

        if (matches.length === 0) {
            if (!confirm(`Send "${name}"?`)) return;
            closeModal('template-modal');
            executeSendTemplate(name, lang, bodyText, []);
            return;
        }

        pendingTemplateData = { name, lang, bodyText };

        const container = document.getElementById('variable-inputs-container');
        container.innerHTML = '';

        document.getElementById('var-template-preview').innerHTML =
            bodyText.replace(/\{\{(\d+)\}\}/g, function (_, num) {
                return '<b style="color:#25D366;">' + '{' + '{' + num + '}' + '}' + '</b>';
            });

        const uniqueVars = new Set(matches.map(m => m[1]));

        uniqueVars.forEach(varNum => {
            const wrapper = document.createElement('div');
            const varLabel = '{' + '{' + varNum + '}' + '}';

            let prefill = '';

            // ðŸŸ¢ AUTO-FILL NAME FOR {{1}}
            if (varNum === '1' && currentChatContext.name) {
                prefill = currentChatContext.name;
            }
            if (varNum === '2' && currentChatContext.order_code) {
                prefill = currentChatContext.order_code;
            }
            if (varNum === '3') {
                prefill = "8-9 days";
            }
            if (varNum === '4' && currentChatContext.cod_value) {
                prefill = currentChatContext.cod_value;
            }
            wrapper.innerHTML =
                '<label style="font-size:12px; color:#00a884; font-weight:bold;">' +
                    'Variable ' + varLabel +
                '</label>' +
                '<input ' +
                    'type="text" ' +
                    'class="var-input" ' +
                    'data-index="' + varNum + '" ' +
                    'value="' + prefill + '" ' +
                    'placeholder="Value for ' + varLabel + '">';

            container.appendChild(wrapper);
        });


        closeModal('template-modal');
        document.getElementById('variable-modal').style.display = 'grid';

        setTimeout(() => container.querySelector('input')?.focus(), 100);
    }


function submitTemplateVariables() {
    if (!pendingTemplateData) return;

    // 1. Gather values
    const inputs = document.querySelectorAll('.var-input');
    const variables = [];
    let missing = false;

    // We need to map inputs back to an ordered array [val1, val2, val3]
    // Meta expects parameters in order: parameters[0] is {{1}}, parameters[1] is {{2}}

    // Sort inputs by data-index to ensure order
    const sortedInputs = Array.from(inputs).sort((a, b) => a.dataset.index - b.dataset.index);

    sortedInputs.forEach(input => {
        const val = input.value.trim();
        if (!val) {
            input.style.border = "1px solid red";
            missing = true;
        } else {
            input.style.border = "none";
            variables.push(val);
        }
    });

    if (missing) return; // Don't send empty vars

    // 2. Close and Send
    closeModal('variable-modal');
    executeSendTemplate(
        pendingTemplateData.name,
        pendingTemplateData.lang,
        pendingTemplateData.bodyText,
        variables
    );
    pendingTemplateData = null;
}

async function executeSendTemplate(name, lang, bodyText, variableArray) {
    isSending = true;

    let displayBody = bodyText;

    variableArray.forEach((val, index) => {
        const token = '{' + '{' + (index + 1) + '}' + '}';
        displayBody = displayBody.replace(token, '<b>' + val + '</b>');
    });

    const formatted = displayBody.replace(/\n/g, '<br>');

    document.getElementById('messages').insertAdjacentHTML(
        'beforeend',
        `<div class="msg sent">${formatted}
         <div class="msg-meta">Now ${getTickHtml('sent')}</div></div>`
    );

    document.getElementById('messages').scrollTop =
        document.getElementById('messages').scrollHeight;

    try {
        await fetch('/send_template', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                phone: currentPhone,
                template_name: name,
                language: lang,
                template_body: displayBody,
                variables: variableArray
            })
        });
    } catch (e) {
        alert("Failed to send template");
        console.error(e);
    }

    setTimeout(() => {
        isSending = false;
        refreshChat(false);
    }, 2000);
}

    function filterTemplates() { const q = document.getElementById('template-search').value.toLowerCase(); renderTemplates(allTemplates.filter(t => t.internal_name.toLowerCase().includes(q))); }

    // --- UPLOADS ---
    function toggleAttach() { if (!isSessionActive()) { alert("Session expired."); return; } const m = document.getElementById('attach-menu'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; }
    function triggerUpload(t) { toggleAttach(); const i=document.getElementById('hidden-file-input'); i.accept=t==='image'?'image/*,video/*':'*/*'; i.onchange=(e)=>prepareUpload(e.target.files[0],t); i.click(); }
    function prepareUpload(f,t) { if(!f)return; pendingFile=f; pendingFileType=f.type.startsWith('image')?'image':(f.type.startsWith('video')?'video':'document'); const c=document.getElementById('preview-container'); c.innerHTML=''; document.getElementById('preview-filename').innerText=f.name; document.getElementById('file-caption').value=f.name; if(pendingFileType==='image'){ const img=document.createElement('img');img.id='preview-img';img.src=URL.createObjectURL(f);c.appendChild(img); } else if(pendingFileType==='video'){ const v=document.createElement('video');v.id='preview-video';v.controls=true;v.src=URL.createObjectURL(f);c.appendChild(v); } else { c.innerHTML=`<span class="material-icons" style="font-size:48px;">description</span>`; } document.getElementById('preview-modal').style.display='grid'; }
    function cancelUpload() { document.getElementById('preview-modal').style.display='none'; pendingFile=null; }
    function toggleEmoji() { document.querySelector('emoji-picker').style.display = document.querySelector('emoji-picker').style.display === 'flex' ? 'none' : 'flex'; }

    // --- CONTEXT MENU & MODALS ---
    function showContextMenu(e,p) { e.preventDefault(); const m=document.getElementById('context-menu'); m.style.display='block'; m.style.left=e.pageX+'px'; m.style.top=e.pageY+'px'; contextMenuPhone=p; }
    let contextMenuPhone=null;
    async function markChatUnread() {
            // 1. Hide the menu immediately
            document.getElementById('context-menu').style.display = 'none';

            if (!contextMenuPhone) return;

            locallyMarkedUnread.add(contextMenuPhone);
            renderChatList();

            fetch('/mark_unread', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({phone:contextMenuPhone})
            });
        }
    function showNewChatModal() { document.getElementById('new-chat-modal').style.display='grid'; }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    async function startNewChat() { const p=document.getElementById('new-phone').value.replace(/\D/g,''); if(p.length<7)return alert("Invalid"); await fetch('/create_contact',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:p})}); closeModal('new-chat-modal'); await loadChats(); setTimeout(()=>openChat(p,null),100); }

    function openManageQRModal() { document.getElementById('quick-reply-menu').style.display='none'; document.getElementById('manage-qr-modal').style.display='grid'; resetQRForm(); renderManageQRList(); }
    function renderManageQRList() { const l=document.getElementById('qr-manage-list'); l.innerHTML=''; quickReplies.forEach(qr=>{ const d=document.createElement('div'); d.className='qr-row'; d.innerHTML=`<div style="flex:1;"><span style="color:var(--accent); font-weight:bold;">/${qr.shortcut}</span><div style="font-size:13px; margin-top:2px;">${qr.message}</div></div><div style="display:flex; gap:10px; align-items:center;"><span class="material-icons" style="color:#53bdeb; cursor:pointer;" onclick="startEditQR(${qr.id})">edit</span><span class="material-icons" style="color:#ff4444; cursor:pointer;" onclick="deleteQuickReply(${qr.id})">delete</span></div>`; l.appendChild(d); }); }
    function startEditQR(id) { const qr=quickReplies.find(q=>q.id===id); if(!qr)return; document.getElementById('qr-id').value=qr.id; document.getElementById('new-qr-shortcut').value=qr.shortcut; document.getElementById('new-qr-msg').value=qr.message; document.getElementById('qr-save-btn').innerText="Update"; document.getElementById('qr-cancel-btn').style.display="block"; }
    function resetQRForm() { document.getElementById('qr-id').value=""; document.getElementById('new-qr-shortcut').value=""; document.getElementById('new-qr-msg').value=""; document.getElementById('qr-save-btn').innerText="Add"; document.getElementById('qr-cancel-btn').style.display="none"; }
    async function saveQuickReply() { const id=document.getElementById('qr-id').value; const sc=document.getElementById('new-qr-shortcut').value; const msg=document.getElementById('new-qr-msg').value; if(!sc||!msg)return alert("Fill"); let m='POST', u='/quick_replies'; if(id){m='PUT'; u=`/quick_replies/${id}`;} const r=await fetch(u,{method:m,headers:{'Content-Type':'application/json'},body:JSON.stringify({shortcut:sc, message:msg})}); if(r.ok){resetQRForm(); await loadQuickReplies(); renderManageQRList();} }
    async function deleteQuickReply(id) { if(!confirm("Delete?"))return; await fetch(`/quick_replies/${id}`,{method:'DELETE'}); await loadQuickReplies(); renderManageQRList(); }

    // --- CLICK HANDLERS (Delegation) ---
    let selectedMsg = null;
    let selectedMsgTimestamp = null;
    let selectedMsgType = null;
    document.getElementById('msg-context-menu').addEventListener('click', async (e) => {
        const action = e.target.dataset.action; if(!action || !selectedMsg) return;
        if(action==='reply') setReplyTarget(selectedMsg);
        else if(action==='forward') { clearReplyTarget(); msgInputEl.value=selectedMsg.message||''; msgInputEl.focus(); }
        else if(action==='delete-me') await deleteForMe(selectedMsg);
        else if(action==='delete-everyone') await deleteForEveryone(selectedMsg);
        else if(action==='retry') retryInboxMessage();

        document.getElementById('msg-context-menu').style.display='none';
    });

    document.addEventListener('click', function (e) {
        // Open Msg Menu
        if(e.target.closest('.msg-actions')) {

    e.stopPropagation();

    const row = e.target.closest('.msg');

    selectedMsg = messageById.get(row.dataset.msgId);

    selectedMsgTimestamp = selectedMsg.timestamp;
    selectedMsgType = selectedMsg.media_type;

    toggleRetryVisibility();

    const m = document.getElementById('msg-context-menu');


            // 1. Show temporarily to calculate height
            m.style.visibility = 'hidden';
            m.style.display = 'block';

            // 2. Calculate positioning
            const menuHeight = m.offsetHeight;
            const clickY = e.pageY;
            const windowHeight = window.innerHeight;

            // Default: position below cursor
            let topPos = clickY;

            // If menu goes off-screen, position ABOVE cursor
            if (clickY + menuHeight > windowHeight - 20) { // 20px padding
                topPos = clickY - menuHeight;
            }

            // 3. Apply styles
            m.style.top = topPos + 'px';
            m.style.left = (e.pageX - 100) + 'px';
            m.style.visibility = 'visible';

            // 4. Handle Delete Everyone visibility
            const delAll = m.querySelector('[data-action="delete-everyone"]');
            if (delAll) {
                delAll.style.display = canDeleteForEveryone(selectedMsg) ? 'block' : 'none';
            }
        }
    });




    async function deleteForMe(msg) { await fetch('/delete_for_me', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:msg.id})}); refreshChat(true); }
    async function deleteForEveryone(msg) { if(!confirm("Delete for everyone?"))return; await fetch('/delete_for_everyone', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:msg.id})}); refreshChat(true); }
    function canDeleteForEveryone(msg) { if(!msg || msg.sender!=='agent' || !msg.whatsapp_id) return false; return (Date.now() - new Date(msg.timestamp).getTime()) <= 3600000; }

    // --- RECORDING ---
    async function startRecording() {
        if (!navigator.mediaDevices) return alert("Mic Error");
        try {
            const s = await navigator.mediaDevices.getUserMedia({audio:true});
            let mime='audio/webm';
            if(MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) mime='audio/webm;codecs=opus';
            mediaRecorder = new MediaRecorder(s, {mimeType: mime});
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.start();
            document.getElementById('mic-btn').style.display='none';
            document.getElementById('recording-ui').style.display='flex';
            recStartTime = Date.now();
            recTimerInt = setInterval(()=>{
                const d=Math.floor((Date.now()-recStartTime)/1000);
                document.getElementById('rec-timer').innerText = `${Math.floor(d/60)}:${(d%60).toString().padStart(2,'0')}`;
            },1000);
        } catch(e) { alert("Mic denied"); }
    }
    function stopRecording(send) {
        if(!mediaRecorder)return;
        mediaRecorder.onstop = async () => {
            clearInterval(recTimerInt);
            document.getElementById('recording-ui').style.display='none';
            document.getElementById('mic-btn').style.display='block';
            if(send && audioChunks.length > 0) {
                const b = new Blob(audioChunks, {type:mediaRecorder.mimeType});
                const fd = new FormData(); fd.append('phone',currentPhone); fd.append('file',b,'voice.webm'); fd.append('type','audio');
                isSending=true; document.getElementById('messages').insertAdjacentHTML('beforeend',`<div class="msg sent">ðŸŽ¤ Uploading...</div>`);
                await fetch('/send_attachment',{method:'POST',body:fd});
                setTimeout(() => { isSending=false; lastRenderChecksum=""; refreshChat(true); }, 1500);
            }
        };
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(t=>t.stop());
    }
    function setFilter(t,e) { currentFilter=t; document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active')); e.classList.add('active'); renderChatList(); }
    function filterChats(query) {
        let q = query.toLowerCase().trim();
        let qNormalized = q;
        if (q.startsWith('03')) qNormalized = '923' + q.substring(2);
        else if (q.startsWith('0092')) qNormalized = '92' + q.substring(4);
        else if (q.startsWith('+92')) qNormalized = '92' + q.substring(3);

        document.querySelectorAll('.chat-item').forEach(item => {
            const name = item.querySelector('.chat-name').innerText.toLowerCase();
            const phone = (item.dataset.phone || "").toLowerCase();
            item.style.display = (name.includes(q) || phone.includes(q) || phone.includes(qNormalized)) ? 'flex' : 'none';
        });
    }



    async function openTagModal(specificPhone = null) {
        // 1. Determine which user we are tagging
        const target = specificPhone || currentPhone;
        if (!target) return;

        taggingPhone = target; // Store globally

        // 2. Show Modal Instantly
        document.getElementById('tag-modal').style.display = 'grid';
        document.querySelector('#tag-modal h3').innerText = `Tags: ${taggingPhone}`;
        const container = document.getElementById('tag-selection-area');
        container.innerHTML = '';

        // 3. Get the user's current tags (Just to know what to highlight)
        // We look in 'allChats' because it's already loaded in memory
        const chatUser = allChats.find(c => c.phone === target);

        // Create a simple list of Tag IDs that this user currently has
        const userTagIds = chatUser && chatUser.tags
            ? chatUser.tags.map(t => t.id || t.name) // Handle ID or Name match safely
            : [];

        // 4. Render the MASTER LIST of tags (from Global Config)
        // 'availableTags' comes from the /tags endpoint (Database), so it includes everything.
        availableTags.forEach(t => {
            // Check if the user has this tag (by Name match usually safest if IDs vary)
            // Adjust logic to match property (t.name)
            const isSelected = chatUser && chatUser.tags && chatUser.tags.some(ut => ut.name === t.name);

            const div = document.createElement('div');
            div.className = `tag-choice ${isSelected ? 'selected' : ''}`;
            div.innerText = t.name;
            div.style.borderColor = t.color;

            // Visual Logic
            if(isSelected) {
                div.style.backgroundColor = t.color;
                div.style.color = '#fff';
            } else {
                div.style.backgroundColor = 'transparent';
                div.style.color = t.color; // Colored text when not selected
            }

            // Click Handler
            div.onclick = () => toggleTagAssignment(t, div);
            container.appendChild(div);
        });
    }


    async function toggleTagAssignment(tag, el) {
        if (!taggingPhone) return;

        // âœ… CORRECT VARIABLE (THIS IS THE FIX)
        lastTagInteraction = Date.now();

        // 2. VISUAL TOGGLE
        const isSelected = el.classList.contains('selected');
        const action = isSelected ? 'remove' : 'add';

        el.classList.toggle('selected');
        if (!isSelected) {
            el.style.backgroundColor = tag.color;
            el.style.color = '#fff';
        } else {
            el.style.backgroundColor = 'transparent';
            el.style.color = tag.color;
        }

        // 3. UPDATE LOCAL MEMORY (Optimistic Data)
        const chatUser = allChats.find(c => c.phone === taggingPhone);
        if (chatUser) {
            if (!chatUser.tags) chatUser.tags = [];

            if (action === 'add') {
                if (!chatUser.tags.some(t => t.name === tag.name)) {
                    chatUser.tags.push({
                        id: tag.id,
                        name: tag.name,
                        color: tag.color
                    });
                }
            } else {
                chatUser.tags = chatUser.tags.filter(t => t.name !== tag.name);
            }
        }

        // 4. REFRESH UI ONLY (NO SERVER POLL)
        renderChatList();

        // 5. SEND TO SERVER (ASYNC, NO UI BLOCK)
        fetch('/contact_tags', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
                phone: taggingPhone,
                tag_id: tag.id,
                action: action
            })
        }).catch(err => console.error("Tag sync failed", err));
    }

    function markTagInteraction() {
        lastTagInteraction = Date.now();
    }




async function createNewTag() {
    const name = document.getElementById('new-tag-name').value;
    if(!name) return;

    // Random color generator
    const color = '#' + Math.floor(Math.random()*16777215).toString(16);

    await fetch('/tags', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name: name, color: color })
    });

    document.getElementById('new-tag-name').value = '';
    await loadGlobalTags(); // Refresh global list
    openTagModal(); // Refresh modal list
}
function renderTagFilters() {
    const container = document.getElementById('tag-filters');
    if (!container) return;

    // 1. Calculate Counts (Data Logic)
    const tagCounts = {};
    let untaggedCount = 0;

    // Initialize tag counters
    availableTags.forEach(t => tagCounts[t.name] = 0);

    // Count chats
    allChats.forEach(c => {

        // Use SERVER unread only (ignore local override)
        const hasUnread = (c.unread_count || 0) > 0;

        const tagNames = (c.tags || []).map(t => t.name);

        const isUntagged = tagNames.length === 0;

        const isFollowUp = tagNames.includes("Follow Up");
        const isUpdateBill = tagNames.includes("Update Bill");
        const isReturns = tagNames.includes("Returns");

        // ðŸ”¥ FINAL BUSINESS RULE
        const includeInUntaggedBadge =
            (isUntagged && hasUnread) ||
            isFollowUp ||
            isUpdateBill ||
            (isReturns && hasUnread);

        if (includeInUntaggedBadge) {
            untaggedCount++;
        }

        // âœ… NORMAL TAG BADGES (unchanged)
        tagNames.forEach(t => {
            if (tagCounts[t] !== undefined) {
                tagCounts[t]++;
            } else {
                tagCounts[t] = 1;
            }
        });
    });


    // ðŸŸ¢ Signature optimization (prevent unnecessary re-render)
    const currentSignature =
        JSON.stringify(tagCounts) +
        `|Untagged:${untaggedCount}|Active:${currentFilter}|TotalTags:${availableTags.length}`;

    if (currentSignature === lastTagStateSignature) {
        return;
    }

    lastTagStateSignature = currentSignature;

    // 3. Render DOM
    container.innerHTML = '';

    // -- Untagged Chip --
    const noneActive = currentFilter === 'none';

    const noneBadge = untaggedCount > 0
        ? `<span class="filter-badge">${untaggedCount}</span>`
        : '';

    const noneChip = document.createElement('div');
    noneChip.className = `filter-chip ${noneActive ? 'active' : ''}`;
    noneChip.innerHTML = `Untagged ${noneBadge}`;
    noneChip.onclick = function () {
        setFilter('none', this);
    };

    container.appendChild(noneChip);

    // -- Tag Chips --
    availableTags.forEach(tag => {

        const count = tagCounts[tag.name] || 0;
        const isActive = currentFilter === tag.name;

        const badgeHtml = count > 0
            ? `<span class="filter-badge">${count}</span>`
            : '';

        const chip = document.createElement('div');
        chip.className = `filter-chip ${isActive ? 'active' : ''}`;
        chip.innerHTML = `${tag.name} ${badgeHtml}`;
        chip.onclick = function () {
            setFilter(tag.name, this);
        };

        container.appendChild(chip);
    });
}

document.addEventListener('contextmenu', function (e) {
    const chatItem = e.target.closest('.chat-item');
    if (!chatItem) return;

    e.preventDefault(); // â›” block browser menu

    const phone = chatItem.id?.replace('chat-item-', '');
    if (!phone) return;

    contextMenuPhone = phone;

    const menu = document.getElementById('context-menu');
    if (!menu) return;

    menu.style.display = 'block';
    menu.style.left = e.pageX + 'px';
    menu.style.top = e.pageY + 'px';
});

let currentAutomationIntent = null;

function showAutomationBanner(preview) {
    currentAutomationIntent = preview.intent;
    document.getElementById("automation-text").innerText =
        preview.preview_text || "";
    document.getElementById("automation-banner").style.display = "block";
}

function hideAutomationBanner() {
    currentAutomationIntent = null;
    const b = document.getElementById("automation-banner");
    if (b) b.style.display = "none";
}

document.addEventListener("DOMContentLoaded", () => {
    const sendBtn = document.getElementById("automation-send");
    const ignoreBtn = document.getElementById("automation-ignore");

    if (sendBtn) {
        sendBtn.onclick = () => {
            if (!currentAutomationIntent || !currentPhone) return;

            fetch("/automation/execute", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    phone: currentPhone,
                    intent: currentAutomationIntent
                })
            }).then(() => hideAutomationBanner());
        };
    }

    if (ignoreBtn) {
        ignoreBtn.onclick = hideAutomationBanner;
    }
});
function toggleRetryVisibility(){

    const retryBtn = document.querySelector(".retry-item");

    // Only show for media messages
    if(!selectedMsgType){
        retryBtn.style.display = "none";
        return;
    }

    // Hide for text
    if(selectedMsgType === "text"){
        retryBtn.style.display = "none";
        return;
    }

    // 24 hour session rule
    const msgTime = new Date(selectedMsgTimestamp);
    const hours = (Date.now() - msgTime) / 3600000;

    if(hours > 24){
        retryBtn.innerText = "Time Expired";
        retryBtn.style.pointerEvents = "none";
        retryBtn.style.opacity = "0.5";
    } else {
        retryBtn.innerText = "Retry Media";
        retryBtn.style.pointerEvents = "auto";
        retryBtn.style.opacity = "1";
    }

    retryBtn.style.display = "block";
}

async function retryInboxMessage(){

    if(!selectedMsgId) return;

    if(!confirm("Retry sending this media?")) return;

    const res = await fetch("/api/retry_media", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            whatsapp_id: selectedMsgId
        })
    });

    const data = await res.json();

    if(data.success){
        alert("âœ… Media resent successfully");
    }else{
        alert("âŒ Retry failed");
    }
}

</script>
</body>
</html>
