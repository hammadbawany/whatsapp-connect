<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Web</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <style>
    .deleted-msg {
    display: inline-block;
    font-style: italic;
    font-size: 13px;
    color: #8696a0;
    padding: 6px 10px;
    background: #1f2c34;
    border-radius: 8px;
    animation: deletedFadeIn 180ms ease-out;
}

/* Smooth collapse animation */
.msg.deleted {
    animation: collapseMsg 160ms ease-out forwards;
}

/* Animations */
@keyframes deletedFadeIn {
    from {
        opacity: 0;
        transform: translateY(-2px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes collapseMsg {
    from {
        opacity: 1;
        max-height: 500px;
    }
    to {
        opacity: 1;
        max-height: 80px;
    }
}
    .menu-divider {
        height: 1px;
        background: #2a3942;
        margin: 6px 0;
    }

    .context-menu .danger {
        color: #f15c6d;
    }

    /* Overall composer */
    .composer {
        background: #1f2c34;
        padding: 8px;
        border-top: 1px solid #2a3942;
    }

    .reply-bar-container {
        width: 100%;
        box-sizing: border-box;
    }



    /* make reply UI inside the bar align and not overflow */
    .reply-ui { display:flex; align-items:center; gap:10px; }
    .reply-preview-text, .reply-preview { max-width: 100%; }
.reply-body {
    flex: 1;
    overflow: hidden;
}

.reply-name {
    font-size: 13px;
    font-weight: 600;
    color: #25D366;
}


.reply-close {
    cursor: pointer;
    font-size: 16px;
    color: #8696a0;
}

/* Input row */
.input-row {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #2a3942;
    border-radius: 8px;
    padding: 8px 10px;
}

.input-row input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: #e9edef;
    font-size: 14px;
}

.icon {
    cursor: pointer;
    color: #8696a0;
    font-size: 18px;
}

.icon.mic {
    font-size: 20px;
}


    .context-menu {
        position: absolute;
        background: #1f2c34;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        display: none;
        z-index: 9999;
        min-width: 140px;
    }

    .context-menu .menu-item {
        padding: 10px 14px;
        cursor: pointer;
        font-size: 14px;
    }

    .context-menu .menu-item:hover {
        background: #2a3942;
    }

    msg {
        position: relative;
    }

    /* Default (received messages) */
    .msg.received .msg-actions {
        position: absolute;
        top: 8px;
        right: -18px;
    }

    /* Sent messages (You) */
    .msg.sent .msg-actions {
        position: absolute;
        top: 8px;
        left: -18px;
    }

    .msg-actions {
        font-size: 14px;
        cursor: pointer;
        user-select: none;
        color: #8696a0;
        opacity: 1; /* always visible as you wanted */
    }


    .reply-preview {
    display: flex;
    cursor: pointer;
    margin-bottom: 4px;
    }

    .reply-bar {
        width: 3px;
        background: #25D366;
        margin-right: 6px;
        border-radius: 2px;
    }

    .reply-content {
        font-size: 12px;
        color: #8696a0;
    }

    .reply-author {
        font-weight: 600;
        color: #25D366;
        margin-bottom: 2px;
    }

    .reply-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .reply-thumb {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 4px;
    }
    .reply-highlight {
    animation: replyFlash 1.2s ease;
      }

      @keyframes replyFlash {
          0%   { background-color: rgba(37, 211, 102, 0.35); }
          100% { background-color: inherit; }
      }

    .date-divider {
      align-self: center;
      background: var(--system-msg-bg);
      color: var(--secondary-text);
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 8px;
      margin: 12px 0;
    }
    .reply-preview {
      border-left: 4px solid #00a884;
      background: rgba(255,255,255,0.06);
      padding: 6px 8px;
      margin-bottom: 6px;
      border-radius: 4px;
    }

    .reply-author {
      font-size: 12px;
      font-weight: 600;
      color: #00a884;
    }

    .reply-text {
      font-size: 12px;
      color: #d1d7db;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }


        :root {
            --bg-color: #0c1317; --sidebar-bg: #111b21; --header-bg: #202c33;
            --border-color: #2a3942; --incoming-bg: #202c33; --outgoing-bg: #005c4b;
            --primary-text: #e9edef; --secondary-text: #8696a0; --input-bg: #2a3942;
            --accent: #00a884; --system-msg-bg: #182229;
            --tick-gray: #8696a0; --tick-blue: #53bdeb;
            --wati-green: #25D366;
        }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #000; height: 100vh; overflow: hidden; color: var(--primary-text); }
        #app { display: flex; height: 100%; width: 100%; }

        .material-icons {
            font-family: 'Material Icons'; font-weight: normal; font-style: normal; font-size: 24px;
            display: inline-block; line-height: 1; text-transform: none; letter-spacing: normal;
            word-wrap: normal; white-space: nowrap; direction: ltr; -webkit-font-smoothing: antialiased;
        }

        #sidebar { width: 400px; display: flex; flex-direction: column; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); }
        .header { height: 60px; background: var(--header-bg); padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; }
        .my-avatar { width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center; cursor: pointer; color: white; font-weight: bold; font-size: 14px; background-color: #6a7f8a; }
        .icon-btn { color: #aebac1; cursor: pointer; padding: 8px; border-radius: 50%; display:flex; align-items:center; justify-content:center; }
        .icon-btn:hover { background: rgba(255,255,255,0.1); }

        .filter-bar { padding: 8px 15px; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid var(--border-color); }
        .filter-chip { padding: 5px 12px; border-radius: 20px; background: var(--header-bg); color: var(--secondary-text); font-size: 13px; cursor: pointer; border: 1px solid transparent; }
        .filter-chip.active { background: var(--accent); color: #fff; }
        /* Badge for filter chip */
        .filter-badge { background: var(--wati-green); color: black; border-radius: 50%; padding: 2px 6px; font-size: 10px; margin-left: 5px; font-weight: bold; display:none; }

        .search-box { padding: 8px 12px; }
        .search-input { width: 100%; background: var(--header-bg); border: none; padding: 8px 30px 8px 15px; border-radius: 8px; color: #fff; outline: none; }

        #chat-list { flex: 1; overflow-y: auto; }
        .chat-item { display: flex; align-items: center; padding: 0 15px; height: 72px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .chat-item:hover { background: #202c33; }
        .chat-item.active { background: #2a3942; }
        .chat-avatar { width: 49px; height: 49px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 500; color: #fff; background-color: #6a7f8a; }
        .chat-info { flex: 1; margin-left: 15px; overflow: hidden; }
        .chat-top { display: flex; justify-content: space-between; margin-bottom: 3px; }
        .chat-name { font-size: 17px; color: var(--primary-text); }
        .chat-time { font-size: 12px; color: var(--secondary-text); }
        .chat-msg { font-size: 14px; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 5px;}
        .unread-badge { background: var(--accent); color: #111b21; font-size: 12px; font-weight: bold; border-radius: 50%; min-width: 20px; height: 20px; display: grid; place-items: center; padding: 0 4px;}

        #chat-view { flex: 1; display: flex; flex-direction: column; background: #0b141a; position: relative; }
        #chat-view::before { content: ''; position: absolute; width: 100%; height: 100%; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); opacity: 0.06; pointer-events: none; }
        .chat-header { height: 60px; background: var(--header-bg); padding: 0 16px; display: flex; align-items: center; z-index: 2; }

        .session-timer { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--wati-green); color: var(--wati-green); font-weight: bold; font-size: 11px; display: grid; place-items: center; margin-right: 15px; background: rgba(37, 211, 102, 0.1); cursor: help; }
        .session-expired { border-color: red; color: red; background: rgba(255,0,0,0.1); }

        #messages { flex: 1; overflow-y: auto; padding: 20px 5%; display: flex; flex-direction: column; z-index: 1; }
        .msg { max-width: 65%; padding: 6px 7px 8px 9px; margin-bottom: 4px; border-radius: 8px; position: relative; font-size: 14.2px; line-height: 19px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .msg.sent { align-self: flex-end; background: var(--outgoing-bg); border-top-right-radius: 0; }
        .msg.received { align-self: flex-start; background: var(--incoming-bg); border-top-left-radius: 0; }
        .msg-meta { float: right; margin-left: 10px; margin-top: 4px; font-size: 11px; color: rgba(255,255,255,0.6); display: flex; align-items: center; gap: 2px; }

        .tick { font-size: 16px; font-weight: bold; }
        .tick.sent { color: var(--tick-gray); }
        .tick.delivered { color: var(--tick-gray); }
        .tick.read { color: var(--tick-blue); }
        .phone-link { color: #53bdeb; cursor: pointer; text-decoration: none; font-weight: 500; }
        .phone-link:hover { text-decoration: underline; }

        .chat-media { max-width: 200px; max-height: 200px; width: auto; height: auto; object-fit: contain; border-radius: 6px; margin-top: 5px; cursor: pointer; background-color: rgba(0,0,0,0.1); }

        #footer {
            min-height: 62px;
            background: var(--header-bg);
            padding: 5px 16px;
            display: flex;
            align-items: flex-end; /* üî• KEY FIX */
            gap: 10px;
            z-index: 2;
            position: relative;
        }        .input-bar:disabled { opacity: 0.5; cursor: not-allowed; }
        .input-bar {
            flex: 1; background: var(--input-bg); border-radius: 8px; padding: 10px 12px; color: #fff; border: none; outline: none; font-size: 15px; font-family: inherit; resize: none; height: 42px; overflow-y: hidden;
        }

        .template-btn { background: var(--wati-green); color: white; border: none; padding: 8px 12px; border-radius: 5px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px; }
        .template-btn:hover { background: #1eac52; }

        emoji-picker { position: absolute; bottom: 70px; left: 20px; z-index: 100; --background: #111b21; --border-color: #2a3942; display: none; }
        .attach-menu { position: absolute; bottom: 70px; left: 50px; background: #233138; border-radius: 10px; display: none; flex-direction: column; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 100;}
        .attach-opt { padding: 12px 20px; display: flex; align-items: center; gap: 10px; cursor: pointer; color: #d1d7db; }
        .attach-opt:hover { background: #111b21; }

        .quick-reply-menu { position: absolute; bottom: 70px; left: 100px; background: #233138; border-radius: 10px; display: none; flex-direction: column; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 100; width: 250px; max-height: 300px; overflow-y: auto;}
        .qr-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #2a3942; color: #e9edef; font-size: 14px; }
        .qr-item:hover { background: #111b21; }
        .qr-item strong { color: var(--accent); display:block; font-size: 12px;}
        .qr-manage-btn { padding: 10px; text-align: center; background: #2a3942; color: var(--accent); cursor: pointer; font-weight: bold; font-size: 13px;}

        #slash-popup { position: absolute; bottom: 70px; left: 150px; background: #233138; border-radius: 8px; width: 300px; max-height: 250px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .slash-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #2a3942; }
        .slash-item:hover { background: #111b21; }
        .slash-shortcut { color: var(--accent); font-weight: bold; }

        .context-menu { display: none; position: absolute; z-index: 1000; background-color: var(--header-bg); border: 1px solid var(--border-color); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); padding: 5px 0; width: 180px; }
        .context-menu-item { padding: 8px 15px; color: var(--primary-text); cursor: pointer; font-size: 14px; }
        .context-menu-item:hover { background-color: #2a3942; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; place-items: center; z-index: 200; }
        .modal { background: var(--header-bg); padding: 20px; border-radius: 10px; width: 450px; color: #fff; display: flex; flex-direction: column; gap: 15px; max-height: 80vh; }
        .modal h3 { margin: 0; }
        .modal input, .modal textarea { width: 100%; padding: 10px; background: var(--input-bg); border: none; color: #fff; border-radius: 5px; outline: none; font-family: inherit;}
        .modal-buttons { display:flex; justify-content:flex-end; gap:10px; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: var(--accent); color: #111b21; }
        .btn-sec { background: transparent; color: var(--accent); }

        #template-list, #qr-manage-list { overflow-y: auto; max-height: 300px; display: flex; flex-direction: column; gap: 10px; }
        .template-item, .qr-row { background: #111b21; padding: 10px; border-radius: 5px; cursor: pointer; border: 1px solid transparent; position: relative;}
        .template-item:hover { border-color: var(--accent); }
        .template-body { font-size: 12px; color: var(--secondary-text); margin-top: 5px; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4; }
        .qr-delete { position: absolute; right: 10px; top: 10px; color: red; cursor: pointer; display: none; }
        .qr-row:hover .qr-delete { display: block; }

        #preview-container { width: 100%; max-height: 300px; overflow: hidden; display: flex; justify-content: center; background: #000; border-radius: 5px;}
        #preview-img { max-width: 100%; max-height: 300px; object-fit: contain; }
        #preview-video { max-width: 100%; max-height: 300px; }
        #recording-ui { display: none; color: #f00; align-items: center; gap: 10px; flex: 1; }
        .rec-dot { width: 10px; height: 10px; background: red; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        #image-viewer { display: none; position: fixed; z-index: 3000; padding-top: 50px; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.9); cursor: zoom-out; justify-content: center; align-items: center; }
        #full-image { margin: auto; display: block; width: auto; height: auto; max-width: 90%; max-height: 90vh; object-fit: contain; animation-name: zoom; animation-duration: 0.3s; border-radius: 5px; box-shadow: 0 0 20px rgba(255,255,255,0.1); }
        #viewer-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; }
    </style>
</head>
<body>

<div id="app">
    <aside id="sidebar">
        <div class="header">
            <div class="my-avatar" id="my-avatar" title="My Profile"><span class="material-icons">person</span></div>
            <div style="display: flex; gap: 15px;">
                <span class="material-icons icon-btn" title="New Chat" onclick="showNewChatModal()">chat</span>
                <span class="material-icons icon-btn" title="Logout" onclick="window.location.href='/logout'">logout</span>
            </div>
        </div>
        <div class="filter-bar">
            <div class="filter-chip active" onclick="setFilter('all', this)">All</div>
            <div class="filter-chip" onclick="setFilter('unread', this)">Unread <span id="filter-unread" class="filter-badge"></span></div>
        </div>
        <div class="search-box"><input type="text" class="search-input" placeholder="Search or start new chat" onkeyup="filterChats(this.value)"></div>
        <div id="chat-list"></div>
    </aside>

    <main id="chat-view">
        <div class="chat-header">
            <div class="session-timer" id="session-timer" title="Time remaining to reply">--</div>
            <div class="chat-avatar" id="header-avatar" style="width: 35px; height: 35px; font-size: 14px;"></div>
            <div class="chat-title" style="margin-left: 10px;">
                <div id="active-contact">Select a chat</div>
                <div id="active-name" class="chat-subtitle"></div>
            </div>
        </div>
        <div id="messages">
            <div style="text-align: center; margin-top: 20%; color: var(--secondary-text);">
                <h2>WhatsApp Web</h2>
                <p>Send and receive messages without keeping your phone online.</p>
            </div>
        </div>

        <footer id="footer">
            <span class="material-icons icon-btn" onclick="toggleEmoji()">sentiment_satisfied_alt</span>
            <span class="material-icons icon-btn"
                  onclick="console.log('üìé ATTACH CLICKED'); toggleAttach(event)">
              attach_file
            </span>
                        <span class="material-icons icon-btn" style="color: #FFC107;" title="Quick Reply" onclick="toggleQuickReplies()">flash_on</span>

            <!-- composer-wrapper holds reply bar ABOVE the input and stretches to fill footer -->
            <div class="composer-wrapper" style="flex:1; display:flex; flex-direction:column; gap:6px;">
                <div id="reply-bar" class="reply-bar-container" style="display:none; width:100%;"></div>

                <textarea
                    id="msg-input"
                    class="input-bar"
                    placeholder="Type a message (or / for replies)"
                    rows="1"
                    disabled>
                </textarea>
            </div>

            <button class="template-btn" onclick="openTemplateModal()">Template</button>
            <span class="material-icons icon-btn" id="send-btn" onclick="sendMessage()" style="display:none;">send</span>
            <span class="material-icons icon-btn" id="mic-btn" onclick="startRecording()">mic</span>
            <div id="recording-ui">
       <div class="rec-dot"></div><span id="rec-timer">0:00</span>
       <span class="material-icons icon-btn" style="color:red; margin-left:auto;" onclick="stopRecording(false)">delete</span>
       <span class="material-icons icon-btn" style="color:var(--accent);" onclick="stopRecording(true)">send</span>
   </div>
        <emoji-picker></emoji-picker>
            <div class="attach-menu" id="attach-menu">
                <div class="attach-opt" onclick="triggerUpload('image')"><span class="material-icons" style="color:#d3396d;">image</span> Photos & Videos</div>
                <div class="attach-opt" onclick="triggerUpload('document')"><span class="material-icons" style="color:#5f66cd;">description</span> Document</div>
            </div>
            <div class="quick-reply-menu" id="quick-reply-menu">
                <div id="qr-list-content"></div> <!-- üî• REQUIRED -->
                <div class="qr-manage-btn" onclick="openManageQRModal()">Manage replies</div>
            </div>
                        <div id="slash-popup"></div>
        </footer>
    </main>
</div>

<div id="context-menu" class="context-menu">
    <div class="context-menu-item" onclick="markChatUnread()">Mark as unread</div>
</div>
<div id="image-viewer" onclick="closeImageViewer()">
    <span id="viewer-close" onclick="closeImageViewer()">&times;</span>
    <img id="full-image">
</div>

<div class="modal-overlay" id="new-chat-modal">
    <div class="modal">
        <h3>New Chat</h3>
        <input type="text" id="new-phone" placeholder="Phone Number">
        <div class="modal-buttons"><button class="btn btn-sec" onclick="closeModal('new-chat-modal')">Cancel</button><button class="btn btn-primary" onclick="startNewChat()">Start Chat</button></div>
    </div>
</div>
<div class="modal-overlay" id="preview-modal">
    <div class="modal">
        <h3>Send File</h3>
        <div id="preview-container"></div>
        <div id="preview-filename" style="font-size:12px; color:#aaa; margin-top:5px;"></div>
        <input type="text" id="file-caption" placeholder="Add a caption...">
        <div class="modal-buttons"><button class="btn btn-sec" onclick="cancelUpload()">Cancel</button><button class="btn btn-primary" onclick="confirmUpload()">Send</button></div>
    </div>
</div>
<div class="modal-overlay" id="template-modal">
    <div class="modal" style="width: 500px;">
        <h3>Select Template</h3>
        <input type="text" id="template-search" placeholder="Search templates..." onkeyup="filterTemplates()">
        <div id="template-list"></div>
        <div class="modal-buttons"><button class="btn btn-sec" onclick="closeModal('template-modal')">Cancel</button></div>
    </div>
</div>
<div class="modal-overlay" id="manage-qr-modal">
    <div class="modal" style="width: 600px;">
        <h3>Manage Quick Replies</h3>
        <div style="display:flex; flex-direction: column; gap:10px;">
            <input type="hidden" id="qr-id">
            <div style="display: flex; gap: 10px;">
                <input type="text" id="new-qr-shortcut" placeholder="Shortcut (e.g. intro)" style="width:30%;">
                <textarea id="new-qr-msg" rows="3" placeholder="Full message..." style="flex:1;"></textarea>
            </div>
            <div style="display:flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-sec" onclick="resetQRForm()" id="qr-cancel-btn" style="display:none;">Cancel Edit</button>
                <button class="btn btn-primary" onclick="saveQuickReply()" id="qr-save-btn">Add Reply</button>
            </div>
        </div>
        <div id="qr-manage-list" style="margin-top:15px; border-top:1px solid #333; padding-top:10px;"></div>
        <div class="modal-buttons"><button class="btn btn-sec" onclick="closeModal('manage-qr-modal')">Close</button></div>
    </div>
</div>
<input type="file" id="hidden-file-input" style="display:none;">
<div id="msg-context-menu" class="context-menu">
    <div class="menu-item" data-action="reply">Reply</div>
    <div class="menu-item" data-action="forward">Forward</div>

    <div class="menu-divider"></div>

    <div class="menu-item" data-action="delete-me">Delete for me</div>
    <div class="menu-item danger" data-action="delete-everyone">Delete for everyone</div>
</div>



<script>
    // --- STATE VARIABLES ---
    let locallyMarkedUnread = new Set();

    const messageById = new Map();
    let selectedMsg = null;
    let lastRenderedMessages = [];
    let replyTarget = null;
    let isNavigatingToReply = false;
    let currentPhone = null;
    let chatHistoryTimer = null;
    let chatListTimer = null;
    let allChats = [], allTemplates = [], quickReplies = [];
    let currentFilter = 'all';
    let isSending = false;
    let lastUserMsgTime = null;
    let mediaRecorder, audioChunks, recStartTime, recTimerInt;
    let pendingFile = null, pendingFileType = null;

    document.getElementById('msg-context-menu')
        .addEventListener('click', async (e) => {

        const item = e.target.closest('.menu-item');
        if (!item || !selectedMsg) return;

        const action = item.dataset.action;

        switch (action) {
            case 'reply':
                setReplyTarget(selectedMsg);
                break;

            case 'forward':
                forwardMessage(selectedMsg);
                break;

            case 'delete-me':
                await deleteForMe(selectedMsg);
                break;

            case 'delete-everyone':
                await deleteForEveryone(selectedMsg);
                break;
        }

        closeContextMenu();
    });
    function forwardMessage(msg) {
    clearReplyTarget();

    const input = document.getElementById('msg-input');
    input.value = msg.message || '';
    input.focus();
}
async function deleteForMe(msg) {
    console.log('[DELETE_FOR_ME] sending request for', msg);
    try {
        const res = await fetch('/delete_for_me', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ id: msg.id })
        });

        let json;
        try { json = await res.json(); } catch(e) { json = null; }

        console.log('[DELETE_FOR_ME] response', res.status, json);

        if (!res.ok) {
            const err = (json && json.error) ? json.error : `HTTP ${res.status}`;
            console.error('[DELETE_FOR_ME] failed:', err);
            alert('Delete failed: ' + err);
            return;
        }

        // Update UI: prefer dataset msg-id then fallback to wamid
        const dom = document.querySelector(`[data-msg-id="${msg.id}"]`)
                  || document.querySelector(`[data-wamid="${msg.whatsapp_id}"]`);
        if (dom) {
            dom.classList.add('deleted');
            dom.innerHTML = `<span class="deleted-msg">You deleted this message</span>`;
        }

        // Refresh to ensure server state/side-effects are visible
        refreshChat(true);

    } catch (err) {
        console.error('[DELETE_FOR_ME] network error', err);
        alert('Network error while deleting message');
    }
}

async function deleteForEveryone(msg) {
    if (!confirm("Are you sure you want to delete this message for everyone?")) return;

    console.log('[DELETE_FOR_EVERYONE] sending request for', msg);

    // Optimistic UI Update (Fade it out immediately)
    const dom = document.querySelector(`[data-msg-id="${msg.id}"]`);
    if (dom) {
        dom.style.opacity = '0.5';
    }

    try {
        const res = await fetch('/delete_for_everyone', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: msg.id })
        });

        let json = null;
        try { json = await res.json(); } catch (e) {}

        console.log('[DELETE_FOR_EVERYONE] response', res.status, json);

        if (res.ok && json.success) {
            // ‚úÖ Success
            if (dom) {
                dom.classList.add('deleted');
                dom.style.opacity = '1';
                dom.innerHTML = `<span class="deleted-msg">You deleted this message</span>`;
                // Remove the dropdown arrow if present
                const actionBtn = dom.querySelector('.msg-actions');
                if (actionBtn) actionBtn.remove();
            }
            showToast("Message deleted for everyone");
        } else {
            // ‚ùå Failed
            if (dom) dom.style.opacity = '1'; // Revert opacity

            let errMsg = "Could not delete message.";
            if (json && json.details) {
                // Parse Meta error
                try {
                    const metaErr = JSON.parse(json.details);
                    if (metaErr.error && metaErr.error.message) {
                        errMsg += " " + metaErr.error.message;
                    }
                } catch(e) {
                    errMsg += " " + json.details;
                }
            }
            alert(errMsg);
        }

        // Refresh chat to ensure data consistency
        refreshChat(false);

    } catch (err) {
        if (dom) dom.style.opacity = '1';
        console.error('[DELETE_FOR_EVERYONE] network error', err);
        alert("Network error. Please try again.");
    }
}



function showToast(message) {
    // You can replace this with a fancy toast if you have one
    console.log("TOAST:", message);
}

function canDeleteForEveryone(msg) {
    const msgTime = new Date(msg.timestamp).getTime();
    const now = Date.now();
    const ONE_HOUR = 60 * 60 * 1000;

    return (now - msgTime) <= ONE_HOUR;
}
function canDeleteForEveryone(msg) {
    if (!msg) return false;

    // 1Ô∏è‚É£ Only messages sent by YOU
    if (msg.sender !== 'agent') return false;

    // 2Ô∏è‚É£ Must have WhatsApp message id
    if (!msg.whatsapp_id) return false;

    // 3Ô∏è‚É£ Must be within 1 hour
    const msgTime = new Date(msg.timestamp).getTime();
    const ONE_HOUR = 60 * 60 * 1000;

    return (Date.now() - msgTime) <= ONE_HOUR;
}

function openContextMenu(event, el) {
    event.preventDefault();
    event.stopPropagation();

    const bubble = el.closest('.msg');
    if (!bubble) {
        console.warn('[CONTEXT MENU] bubble not found');
        return;
    }

    const msgId = bubble.dataset.msgId;
    if (!msgId) {
        console.warn('[CONTEXT MENU] msgId missing on bubble');
        return;
    }

    selectedMsg = messageById.get(String(msgId));
    if (!selectedMsg) {
        console.warn('[CONTEXT MENU] message not found in map', msgId);
        return;
    }

    console.log('[CONTEXT MENU OPEN]', selectedMsg);

    const menu = document.getElementById('msg-context-menu');
    if (!menu) {
        console.error('[CONTEXT MENU] menu not found');
        return;
    }

    menu.style.display = 'block';
        // üîí WhatsApp rule: only agent messages can be deleted for everyone
        // üîí WhatsApp-style guard: sender + time + wamid
        const deleteEveryoneItem = menu.querySelector('[data-action="delete-everyone"]');

        if (deleteEveryoneItem) {
            if (canDeleteForEveryone(selectedMsg)) {
                deleteEveryoneItem.style.display = 'block';
            } else {
                deleteEveryoneItem.style.display = 'none';
            }
        }

        const rect = el.getBoundingClientRect();
        const menuHeight = menu.offsetHeight;
        const footer = document.getElementById('footer');
        const footerTop = footer ? footer.getBoundingClientRect().top : window.innerHeight;

        const spaceBelow = footerTop - rect.bottom;
        const spaceAbove = rect.top;

        if (spaceBelow < menuHeight && spaceAbove > menuHeight) {
            // üîº Open ABOVE the message
            menu.style.top = (rect.top - menuHeight) + 'px';
        } else {
            // üîΩ Open BELOW the message
            menu.style.top = rect.bottom + 'px';
        }

        menu.style.left = rect.left + 'px';
        // üîí FORCE HIDE 'Delete for Everyone'
         const deleteEveryoneBtn = menu.querySelector('[data-action="delete-everyone"]');
         if (deleteEveryoneBtn) {
             deleteEveryoneBtn.style.display = 'none';
         }
}


    function findMessageByWamid(wamid) {
      return lastRenderedMessages.find(m => m.whatsapp_id === wamid);
    }

    function parseServerTimestamp(ts) {
        // Convert "YYYY-MM-DD HH:mm:ss" ‚Üí ISO
        if (ts && ts.includes(" ")) {
            ts = ts.replace(" ", "T") + "Z";
        }
        return new Date(ts);
    }

    function within24Hours(dateObj) {
        if (!dateObj || isNaN(dateObj)) return false;
        return (Date.now() - dateObj.getTime()) <= (24 * 60 * 60 * 1000);
    }
    // --- INITIALIZATION ---
    loadChats(); loadMyProfile(); loadQuickReplies();
    chatListTimer = setInterval(loadChats, 4000); // Poll chat list 4s

    function dbg(label, data = '') {
    console.log(`[DEBUG] ${label}`, data);
    }

    // --- INPUT HANDLERS ---
    const msgInput = document.getElementById('msg-input');
    const captionInput = document.getElementById('file-caption');

    // üü¢ PASTE HANDLER
    msgInput.addEventListener('paste', function(e) {
      if (!isSessionActive()) {
       alert("24-hour session expired. Media not allowed.");
       e.preventDefault();
       return;
   }
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.kind === 'file') {
                const blob = item.getAsFile();
                if (blob.type.startsWith('image/') || blob.type.startsWith('video/')) {
                    prepareUpload(blob, blob.type.startsWith('video') ? 'video' : 'image');
                    e.preventDefault();
                }
            }
        }
    });

    msgInput.addEventListener('input', function(e) {
        checkInput();
        if (this.value.includes('/')) {
            showSlashPopup(this.value.split('/').pop());
        } else {
            document.getElementById('slash-popup').style.display = 'none';
        }
    });
    msgInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });
    captionInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); confirmUpload(); }
    });
    document.querySelector('emoji-picker').addEventListener('emoji-click', e => {
        msgInput.value += e.detail.unicode; toggleEmoji(); msgInput.focus(); checkInput();
    });

    // --- DATA LOADING ---
    async function loadMyProfile() { try { const r=await fetch('/me'); if(r.ok){ const d=await r.json(); const a=document.getElementById('my-avatar'); a.style.backgroundColor=getAvatarColor(d.username); a.innerText=getInitials(d.username); } } catch(e){} }

    async function loadChats() {
        if (document.querySelector('.search-input').value.trim() !== "") return;
        try {
            const resp = await fetch('/list_users');
            allChats = await resp.json();
            renderChatList();
        } catch(e) { console.error("Load Chats Failed", e); }
    }

    function renderChatList() {
            const list = document.getElementById('chat-list');

            // üü¢ FIX: Select the badge element directly
//            const totalUnread = allChats.reduce((sum, c) => sum + (c.unread_count || 0), 0);
            const totalUnread = allChats.filter(c => (c.unread_count || 0) > 0).length;

            const badgeEl = document.getElementById('filter-unread');

            // Safety check if element exists
            if (badgeEl) {
                if (totalUnread > 0) {
                    badgeEl.innerText = totalUnread;
                    badgeEl.style.display = 'inline-block';
                } else {
                    badgeEl.style.display = 'none';
                }
            }

            const filtered = allChats.filter(c => {
                if (currentFilter === 'unread') return c.unread_count > 0;
                return true;
            });

            // 1. Process Updates & Adds
            filtered.forEach((c, index) => {
                let div = document.getElementById(`chat-item-${c.phone}`);

                // Format Time
                const timeStr = c.last_ts ? new Date(c.last_ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';

                // Unread Badge Logic
                let unreadCount = c.unread_count || 0;

                // üî• Allow manual unread even if chat is open
                if (locallyMarkedUnread.has(c.phone)) {
                    unreadCount = Math.max(unreadCount, 1);
                }

                const unreadHtml = unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : '';

                // Avatar Props
                const bgColor = getAvatarColor(c.phone);
                const initials = c.name ? getInitials(c.name) : "?";
                const displayName = c.name || c.phone;
                const previewMsg = c.media_type ? `üì∑ ${c.media_type}` : (c.last_message || '');

                const htmlContent = `
                    <div class="chat-avatar" style="background-color: ${bgColor};">${initials}</div>
                    <div class="chat-info">
                        <div class="chat-top">
                            <span class="chat-name">${displayName}</span>
                            <span class="chat-time">${timeStr}</span>
                        </div>
                        <div class="chat-top">
                            <span class="chat-msg">${previewMsg}</span>
                            ${unreadHtml}
                        </div>
                    </div>`;

                if (!div) {
                    // CREATE NEW
                    div = document.createElement('div');
                    div.id = `chat-item-${c.phone}`;
                    div.className = `chat-item ${currentPhone === c.phone ? 'active' : ''}`;
                    div.onclick = () => openChat(c.phone, c.name);
                    div.oncontextmenu = (e) => showContextMenu(e, c.phone);
                    div.innerHTML = htmlContent;
                    div.dataset.phone = c.phone; // Important for search
                    list.appendChild(div);
                } else {
                    // UPDATE EXISTING
                    if (div.innerHTML !== htmlContent) div.innerHTML = htmlContent;
                    div.dataset.phone = c.phone;

                    if(currentPhone === c.phone) div.classList.add('active');
                    else div.classList.remove('active');
                }

                // REORDER
                if (list.children[index] !== div) {
                    list.insertBefore(div, list.children[index]);
                }
            });
        }
    // --- CHAT LOGIC ---
    async function openChat(phone, name) {
            if(currentPhone === phone) return;
            if(chatHistoryTimer) clearInterval(chatHistoryTimer);

            // üü¢ RESET OPTIMIZATION COUNTER
            lastRenderedCount = 0;

            currentPhone = phone;

            // ... (rest of your existing UI update logic) ...
            document.querySelectorAll('.chat-item').forEach(e=>e.classList.remove('active'));
            const a=document.getElementById(`chat-item-${phone}`); if(a){a.classList.add('active'); const b=a.querySelector('.unread-badge'); if(b)b.remove();}
            document.getElementById('active-contact').innerText=name||phone; document.getElementById('active-name').innerText=name?phone:'';
            const h=document.getElementById('header-avatar'); h.style.backgroundColor=getAvatarColor(phone); h.innerText=name?getInitials(name):"?";
            document.getElementById('msg-input').disabled=false; document.getElementById('msg-input').focus();
            document.getElementById('messages').innerHTML='<div style="text-align:center;padding:50px;">Loading...</div>';

            fetch('/mark_read',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone})});
            locallyMarkedUnread.delete(phone);

            await refreshChat(true);
            chatHistoryTimer = setInterval(refreshChat, 3000);
        }

        async function refreshChat(forceScroll = false) {

            dbg('refreshChat START', { forceScroll, isNavigatingToReply });

            // üîí Keep date tracking local to this render
            let lastRenderedDate = null;

            if (!currentPhone || isSending) return;

            try {
                // 1Ô∏è‚É£ Fetch Data
                const resp = await fetch(`/history?phone=${currentPhone}`);

                if (!resp.ok) {
                    const text = await resp.text();
                    console.error("‚ùå /history failed", resp.status, text);
                    return;
                }

                const contentType = resp.headers.get("content-type") || "";
                if (!contentType.includes("application/json")) {
                    const text = await resp.text();
                    console.error("‚ùå /history returned non-JSON", text);
                    return;
                }

                const msgs = await resp.json();


                if (isSending) return;

                // üü¢ OPTIMIZATION: Stop re-rendering if nothing changed
                if (!forceScroll && msgs.length === lastRenderedCount) {
                    return;
                }

                // üîí Always render chronologically
                msgs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                lastRenderedMessages = msgs;
                lastRenderedCount = msgs.length;

                const container = document.getElementById('messages');

                dbg('DOM RESET (innerHTML wipe)', {
                    scrollTopBefore: container.scrollTop
                });

                // üîí Reset container (encryption banner stays)
                container.innerHTML = `
                    <div style="text-align:center; margin:20px; color:#8696a0; font-size:12px;">
                        <span class="material-icons" style="font-size:12px;">lock</span>
                        Messages are end-to-end encrypted.
                    </div>
                `;

                lastUserMsgTime = null;

                msgs.forEach(m => {

                    console.log('[RENDER MSG]', {
                        id: m.id,
                        whatsapp_id: m.whatsapp_id,
                        message: m.message
                    });

                    /* =========================
                       üìÖ DATE DIVIDER
                       ========================= */
                    const msgDate = new Date(m.timestamp).toDateString();

                    if (msgDate !== lastRenderedDate) {
                        const divider = document.createElement('div');
                        divider.className = 'date-divider';

                        const today = new Date().toDateString();
                        const yesterday = new Date(Date.now() - 86400000).toDateString();

                        if (msgDate === today) divider.innerText = 'Today';
                        else if (msgDate === yesterday) divider.innerText = 'Yesterday';
                        else {
                            divider.innerText = new Date(m.timestamp).toLocaleDateString(undefined, {
                                day: '2-digit',
                                month: 'short',
                                year: 'numeric'
                            });
                        }

                        container.appendChild(divider);
                        lastRenderedDate = msgDate;
                    }

                    const isSent = m.sender === 'agent';

                    /* =========================
                       ‚è± Track last user message
                       ========================= */
                    if (!isSent) {
                        const ts = parseServerTimestamp(m.timestamp);
                        if (!lastUserMsgTime || ts > lastUserMsgTime) {
                            lastUserMsgTime = ts;
                        }
                    }

                    /* =========================
                       üß± CREATE MESSAGE BUBBLE
                       (MUST COME BEFORE USING div)
                       ========================= */
                    const div = document.createElement('div');
                    div.className = `msg ${isSent ? 'sent' : 'received'}`;

                    if (m.id) {
                        div.dataset.msgId = m.id;
                        messageById.set(String(m.id), m);   // üîí stable lookup for menu
                    }

                    if (m.whatsapp_id) {
                        div.dataset.wamid = m.whatsapp_id;
                    }

                    let content = '';

                    /* =========================
                       üóëÔ∏è DELETE LOGIC
                       ========================= */
                    if (m.deleted_for_everyone) {
                        div.classList.add('deleted');
                        content = `
                            <div class="deleted-msg">
                                ${m.sender === 'agent'
                                    ? 'You deleted this message'
                                    : 'This message was deleted'}
                            </div>
                        `;
                    }
                    else if (m.deleted_for_me) {
                        div.classList.add('deleted');
                        content = `
                            <div class="deleted-msg">
                                ${m.sender === 'agent'
                                    ? 'You deleted this message'
                                    : 'This message was deleted'}
                            </div>
                        `;
                    }
                    else {

                        /* =========================
                           üìé MEDIA / TEXT
                           ========================= */
                        if (m.media_id) {
                            if (m.media_type === 'audio' || m.media_type === 'voice') {
                                content = `
                                    <audio controls preload="none" crossorigin="anonymous">
                                        <source src="/media/${m.media_id}" type="audio/ogg">
                                        Your browser does not support audio.
                                    </audio>
                                `;
                            }
                            else if (m.media_type === 'video') {
                                content = `<video class="chat-media" controls src="/media/${m.media_id}"></video>`;
                            }
                            else if (m.media_type === 'document') {
                                content = `
                                    <div style="padding:10px;">
                                        <a href="/media/${m.media_id}" target="_blank" style="color:var(--primary-text);">
                                            üìÑ Download Document
                                        </a>
                                    </div>
                                `;
                            }
                            else {
                                content = `
                                    <img src="/media/${m.media_id}"
                                         class="chat-media"
                                         loading="lazy"
                                         onclick="openImageViewer(this.src)">
                                `;
                            }

                            if (m.message && m.media_type !== 'audio' && m.media_type !== 'voice') {
                                content += `<div style="margin-top:5px;">${linkify(m.message)}</div>`;
                            }
                        }
                        else {
                            content = linkify(m.message);
                        }
                    }

                    const time = new Date(m.timestamp).toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const tickHtml = isSent ? getTickHtml(m.status) : '';

                    /* =========================
                       ‚Ü©Ô∏è REPLY PREVIEW
                       ========================= */
                    let replyHtml = '';

                    if (m.reply_to) {
                        let previewText = '';
                        let previewThumb = '';

                        if (m.reply_to.message) {
                            previewText = m.reply_to.message.substring(0, 80);
                        }
                        else if (m.reply_to.media_type) {
                            const mediaMap = {
                                image: 'üì∑ Photo',
                                video: 'üé• Video',
                                audio: 'üéµ Audio',
                                voice: 'üéµ Voice message',
                                document: 'üìÑ Document',
                                sticker: 'üß© Sticker'
                            };
                            previewText = mediaMap[m.reply_to.media_type] || 'üìé Attachment';
                        }
                        else {
                            previewText = 'Message';
                        }

                        if (
                            (m.reply_to.media_type === 'image' || m.reply_to.media_type === 'video') &&
                            m.reply_to.media_id
                        ) {
                            previewThumb = `
                                <img src="/media/${m.reply_to.media_id}"
                                     class="reply-thumb"
                                     loading="lazy"
                                     onerror="this.style.display='none'">
                            `;
                        }

                        const replyAttr = m.reply_to.whatsapp_id
                            ? `data-reply-id="${m.reply_to.whatsapp_id}"`
                            : '';

                        replyHtml = `
                            <div class="reply-preview" ${replyAttr}>
                                <div class="reply-bar"></div>
                                <div class="reply-content">
                                    <div class="reply-author">
                                        ${m.reply_to.sender === 'agent' ? 'You' : 'User'}
                                    </div>
                                    <div class="reply-row">
                                        ${previewThumb}
                                        <div class="reply-text">${previewText}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    /* =========================
                       üß© FINAL HTML
                       ========================= */
                    const isDeleted = m.deleted_for_me || m.deleted_for_everyone;

                    div.innerHTML = `
                        ${!isDeleted
                            ? '<span class="msg-actions" onclick="openContextMenu(event, this)">‚ñæ</span>'
                            : ''}
                        ${replyHtml}
                        ${content}
                        <div class="msg-meta">${time} ${tickHtml}</div>
                    `;

                    container.appendChild(div);
                });


                // ‚¨áÔ∏è Scroll behavior
                if (forceScroll && !isNavigatingToReply) {
                    container.scrollTop = container.scrollHeight;
                }

                // ‚è≥ 24h session timer
                updateSessionTimer();

              } catch (e) {
                  console.error('‚ùå refreshChat crashed:', e);
              }
        }


    async function sendMessage() {
        const txt = msgInput.value.trim();
        if (!txt || !currentPhone) return;

        isSending = true;
        if (chatHistoryTimer) clearInterval(chatHistoryTimer);

        msgInput.value = '';
        checkInput();

        const container = document.getElementById('messages');

        /* =========================
           ‚Ü©Ô∏è OPTIMISTIC REPLY PREVIEW
           ========================= */
        let optimisticReplyHtml = '';

        if (replyTarget) {
            let preview = replyTarget.message
                ? replyTarget.message.substring(0, 80)
                : (replyTarget.media_type ? `Replying to ${replyTarget.media_type}` : 'Message');

            optimisticReplyHtml = `
                <div class="reply-preview">
                    <div class="reply-bar"></div>
                    <div class="reply-content">
                        <div class="reply-author">
                            ${replyTarget.sender === 'agent' ? 'You' : 'User'}
                        </div>
                        <div class="reply-text">${preview}</div>
                    </div>
                </div>
            `;
        }

        /* =========================
           üì® OPTIMISTIC MESSAGE RENDER
           ========================= */
        container.insertAdjacentHTML(
            'beforeend',
            `
            <div class="msg sent">
                ${optimisticReplyHtml}
                ${linkify(txt)}
                <div class="msg-meta">Now ${getTickHtml('sent')}</div>
            </div>
            `
        );

        container.scrollTop = container.scrollHeight;

        /* =========================
           üì° SEND TO BACKEND
           ========================= */
        try {
            const payload = {
                phone: currentPhone,
                text: txt
            };

            if (replyTarget && replyTarget.whatsapp_id) {
                payload.reply_to = replyTarget.whatsapp_id;
            }
            /* =========================
               üßπ CLEAR REPLY MODE (AFTER SEND)
               ========================= */
            clearReplyTarget();

            await fetch('/send_text', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(payload)
            });

        } catch (e) {
            console.error('Send failed', e);
        }



        /* =========================
           üîÑ RESTORE CHAT REFRESH
           ========================= */
        setTimeout(() => {
            isSending = false;
            refreshChat(false);
            chatHistoryTimer = setInterval(refreshChat, 3000);
        }, 1500);
    }

    async function loadQuickReplies() { try { const r=await fetch('/quick_replies'); quickReplies=await r.json(); } catch(e){} }
    function toggleQuickReplies() { const m=document.getElementById('quick-reply-menu'); if(m.style.display==='flex') m.style.display='none'; else { renderQuickReplyMenu(); m.style.display='flex'; } }
    function renderQuickReplyMenu() { const l=document.getElementById('qr-list-content'); l.innerHTML = ''; if(quickReplies.length===0) l.innerHTML='No replies.'; quickReplies.forEach(qr=>{ const d=document.createElement('div'); d.className='qr-item'; d.innerHTML=`<strong>/${qr.shortcut}</strong> ${qr.message.substring(0,40)}...`; d.onclick=()=>insertQuickReply(qr.message); l.appendChild(d); }); }
    function showSlashPopup(q) { const p=document.getElementById('slash-popup'); const f=quickReplies.filter(qr=>qr.shortcut.toLowerCase().includes(q.toLowerCase())); if(f.length===0){p.style.display='none';return;} p.innerHTML=''; f.forEach(qr=>{ const d=document.createElement('div'); d.className='slash-item'; d.innerHTML=`<span class="slash-shortcut">/${qr.shortcut}</span> ${qr.message.substring(0,50)}`; d.onclick=()=>{ const v=msgInput.value; msgInput.value=v.substring(0,v.lastIndexOf('/'))+qr.message; p.style.display='none'; msgInput.focus(); checkInput(); }; p.appendChild(d); }); p.style.display='block'; }
    function insertQuickReply(m) { msgInput.value=m; msgInput.focus(); checkInput(); document.getElementById('quick-reply-menu').style.display='none'; }
    function openManageQRModal() { document.getElementById('quick-reply-menu').style.display='none'; document.getElementById('manage-qr-modal').style.display='grid'; resetQRForm(); renderManageQRList(); }
    function renderManageQRList() { const l=document.getElementById('qr-manage-list'); l.innerHTML=''; quickReplies.forEach(qr=>{ const d=document.createElement('div'); d.className='qr-row'; const m=qr.message.replace(/\n/g,'<br>'); d.innerHTML=`<div style="flex:1;"><span style="color:var(--accent); font-weight:bold;">/${qr.shortcut}</span><div style="font-size:13px; margin-top:2px;">${m}</div></div><div style="display:flex; gap:10px; align-items:center;"><span class="material-icons" style="color:#53bdeb; cursor:pointer;" onclick="startEditQR(${qr.id})">edit</span><span class="material-icons" style="color:#ff4444; cursor:pointer;" onclick="deleteQuickReply(${qr.id})">delete</span></div>`; l.appendChild(d); }); }
    function startEditQR(id) { const qr=quickReplies.find(q=>q.id===id); if(!qr)return; document.getElementById('qr-id').value=qr.id; document.getElementById('new-qr-shortcut').value=qr.shortcut; document.getElementById('new-qr-msg').value=qr.message; document.getElementById('qr-save-btn').innerText="Update"; document.getElementById('qr-cancel-btn').style.display="block"; }
    function resetQRForm() { document.getElementById('qr-id').value=""; document.getElementById('new-qr-shortcut').value=""; document.getElementById('new-qr-msg').value=""; document.getElementById('qr-save-btn').innerText="Add"; document.getElementById('qr-cancel-btn').style.display="none"; }
    async function saveQuickReply() { const id=document.getElementById('qr-id').value; const sc=document.getElementById('new-qr-shortcut').value; const msg=document.getElementById('new-qr-msg').value; if(!sc||!msg)return alert("Fill"); let m='POST', u='/quick_replies'; if(id){m='PUT'; u=`/quick_replies/${id}`;} const r=await fetch(u,{method:m,headers:{'Content-Type':'application/json'},body:JSON.stringify({shortcut:sc, message:msg})}); if(r.ok){resetQRForm(); await loadQuickReplies(); renderManageQRList();}else{alert("Error");} }
    async function deleteQuickReply(id) { if(!confirm("Delete?"))return; await fetch(`/quick_replies/${id}`,{method:'DELETE'}); await loadQuickReplies(); renderManageQRList(); }
    async function openTemplateModal() {
        document.getElementById('template-modal').style.display = 'grid';

        const l = document.getElementById('template-list');
        l.innerHTML = 'Loading...';

        try {
            const r = await fetch('/template_aliases');
            const d = await r.json();

            allTemplates = d.filter(t => t.visible_in_ui === true);
            renderTemplates(allTemplates);

        } catch (e) {
            console.error('Template fetch failed', e);
            l.innerHTML = 'Error loading templates';
        }
    }


    function renderTemplates(templates) {
      const list = document.getElementById('template-list');
      list.innerHTML = '';

      if (!templates || templates.length === 0) {
          list.innerHTML = '<div style="color:#8696a0;">No templates found</div>';
          return;
      }

      templates.forEach(t => {
          const div = document.createElement('div');
          div.className = 'template-item';

          // ‚úÖ real preview from DB
          let preview = (t.preview_text || '')
              .split('\n')
              .slice(0, 4)          // üî• only first 3‚Äì4 lines
              .join('<br>');

          div.innerHTML = `
              <div class="template-name">${t.internal_name}</div>
              <div class="template-body">${preview}</div>
          `;

          div.onclick = () => {
              sendTemplate(
                  t.meta_template_name,
                  t.language_code,
                  t.preview_text || ''
              );
          };

          list.appendChild(div);
      });
  }



    function filterTemplates() {
        const q = document.getElementById('template-search').value.toLowerCase();

        renderTemplates(
            allTemplates.filter(t =>
                t.internal_name.toLowerCase().includes(q)
            )
        );
    }
    async function sendTemplate(n,l,c) { if(!confirm(`Send "${n}"?`))return; closeModal('template-modal'); if(chatHistoryTimer)clearInterval(chatHistoryTimer); isSending=true; const formattedText = c.replace(/\n/g,'<br>'); document.getElementById('messages').insertAdjacentHTML('beforeend',`<div class="msg sent">${formattedText} <div class="msg-meta">Now ${getTickHtml('sent')}</div></div>`); document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight; try{await fetch('/send_template',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:currentPhone,template_name:n,language:l,template_body:c})});}catch(e){alert("Failed");} setTimeout(()=>{isSending=false;refreshChat(false);chatHistoryTimer=setInterval(refreshChat,3000);},2000); }
    function setFilter(t,e) { currentFilter=t; document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active')); e.classList.add('active'); renderChatList(); }
    function filterChats(query) {
            // 1. Clean the input (remove extra spaces)
            let q = query.toLowerCase().trim();

            // 2. Create a "Normalized" version for phone search
            // If user types '0346...', we also want to search for '92346...'
            let qNormalized = q;
            if (q.startsWith('03')) {
                qNormalized = '923' + q.substring(2);
            } else if (q.startsWith('0092')) {
                 qNormalized = '92' + q.substring(4);
            } else if (q.startsWith('+92')) {
                 qNormalized = '92' + q.substring(3);
            }

            document.querySelectorAll('.chat-item').forEach(item => {
                const name = item.querySelector('.chat-name').innerText.toLowerCase();
                const phone = (item.dataset.phone || "").toLowerCase();

                // 3. Search Logic:
                // Check if Name contains query
                // OR Phone contains raw query (e.g. 923...)
                // OR Phone contains normalized query (e.g. user typed 0346, we match 92346)
                if (name.includes(q) || phone.includes(q) || phone.includes(qNormalized)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
    function showNewChatModal() { document.getElementById('new-chat-modal').style.display='grid'; }
    function closeModal(id) { document.getElementById(id).style.display='none'; }
    async function startNewChat() { const p=document.getElementById('new-phone').value.replace(/\D/g,''); if(p.length<7)return alert("Invalid"); await fetch('/create_contact',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:p})}); closeModal('new-chat-modal'); await loadChats(); setTimeout(()=>openChat(p,null),100); }
    function updateSessionTimer() { const t=document.getElementById('session-timer'); const i=document.getElementById('msg-input'); if(!lastUserMsgTime){t.innerText="--";i.disabled=true;i.placeholder="24h session expired";return;} const r=(24*3600*1000)-(new Date()-lastUserMsgTime); if(r>0){ const h=Math.floor(r/3600000); const m=Math.floor((r%3600000)/60000); t.innerText=`${h}:${m<10?'0'+m:m}`; t.classList.remove('session-expired'); i.disabled=false; i.placeholder="Type a message"; } else { t.innerText="00:00"; t.classList.add('session-expired'); i.disabled=true; i.placeholder="Send a template."; } }
    function toggleEmoji() { document.querySelector('emoji-picker').style.display = document.querySelector('emoji-picker').style.display === 'flex' ? 'none' : 'flex'; }
    function toggleAttach() {
        if (!isSessionActive()) {
            alert("24-hour session expired. You can only send templates.");
            return;
        }
        const m = document.getElementById('attach-menu');
        m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
    }

        function triggerUpload(t) { toggleAttach(); const input = document.getElementById('hidden-file-input'); input.accept = t==='image'?'image/*,video/*':'*/*'; input.onchange = (e) => prepareUpload(e.target.files[0],t); input.click(); }
    function prepareUpload(f,t) { if(!f||!currentPhone)return; pendingFile=f; if(f.type.startsWith('video'))pendingFileType='video';else if(f.type.startsWith('image'))pendingFileType='image';else pendingFileType='document'; const c=document.getElementById('preview-container'); c.innerHTML=''; document.getElementById('preview-filename').innerText=f.name; document.getElementById('file-caption').value=''; if(pendingFileType==='image'){const img=document.createElement('img');img.id='preview-img';img.src=URL.createObjectURL(f);c.appendChild(img);}else if(pendingFileType==='video'){const v=document.createElement('video');v.id='preview-video';v.controls=true;v.src=URL.createObjectURL(f);c.appendChild(v);}else{c.innerHTML=`<span class="material-icons" style="font-size:48px;">description</span>`;} document.getElementById('preview-modal').style.display='grid'; }
    function cancelUpload() { document.getElementById('preview-modal').style.display='none'; pendingFile=null; document.getElementById('hidden-file-input').value=""; }
    async function confirmUpload() {
      if (!isSessionActive()) {
              alert("24-hour session expired. Use a template.");
              cancelUpload();
              return;
          }

       if(!pendingFile)return; const cap=document.getElementById('file-caption').value; const fd=new FormData(); fd.append('phone',currentPhone); fd.append('file',pendingFile); fd.append('type',pendingFileType); fd.append('caption',cap); document.getElementById('preview-modal').style.display='none'; isSending=true; document.getElementById('messages').insertAdjacentHTML('beforeend',`Uploading...`); await fetch('/send_attachment',{method:'POST',body:fd}); pendingFile=null; document.getElementById('hidden-file-input').value=""; setTimeout(()=>{isSending=false;refreshChat(true);},2000); }
    let recorderMimeType = 'audio/webm'; // Default fallback
/*
    async function startRecording() {
        if (!navigator.mediaDevices) return alert("Microphone error");

        // 1. Determine best supported format
        if (MediaRecorder.isTypeSupported('audio/ogg; codecs=opus')) {
            recorderMimeType = 'audio/ogg; codecs=opus';
        } else if (MediaRecorder.isTypeSupported('audio/webm; codecs=opus')) {
            recorderMimeType = 'audio/webm; codecs=opus';
        } else {
            recorderMimeType = 'audio/mp4'; // Safari fallback
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: recorderMimeType });
            audioChunks = [];

            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) audioChunks.push(e.data);
            };

            mediaRecorder.start();

            // UI
            document.getElementById('mic-btn').style.display = 'none';
            document.getElementById('msg-input').style.display = 'none';
            document.getElementById('recording-ui').style.display = 'flex';
            document.getElementById('rec-timer').innerText = "0:00";

            // Timer
            recStartTime = Date.now();
            if(recTimerInt) clearInterval(recTimerInt);
            recTimerInt = setInterval(() => {
                const diff = Math.floor((Date.now() - recStartTime)/1000);
                const m = Math.floor(diff/60);
                const s = diff % 60;
                document.getElementById('rec-timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
            }, 1000);

        } catch(e) {
            console.error(e);
            alert("Mic access denied");
        }
    }
*/

async function startRecording() {
    if (!navigator.mediaDevices) {
        alert("Microphone not supported");
        return;
    }

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    let mimeType = "";

    if (MediaRecorder.isTypeSupported("audio/webm;codecs=opus")) {
        mimeType = "audio/webm;codecs=opus";
    } else if (MediaRecorder.isTypeSupported("audio/webm")) {
        mimeType = "audio/webm";
    } else {
        alert("No supported audio format found");
        return;
    }

    console.log("üéôÔ∏è Using MediaRecorder mimeType:", mimeType);

    mediaRecorder = new MediaRecorder(stream, { mimeType });
    audioChunks = [];

    mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) audioChunks.push(e.data);
    };

    mediaRecorder.start(); // üî¥ THIS was not firing correctly before

    document.getElementById('mic-btn').style.display = 'none';
    document.getElementById('msg-input').style.display = 'none';
    document.getElementById('recording-ui').style.display = 'flex';

    recStartTime = Date.now();

    recTimerInt = setInterval(() => {
        const diff = Math.floor((Date.now() - recStartTime) / 1000);

        const timerEl = document.getElementById('rec-timer');
        if (!timerEl) {
            // UI not present ‚Üí avoid crash
            return;
        }

        timerEl.innerText =
            `${Math.floor(diff / 60)}:${String(diff % 60).padStart(2, '0')}`;
    }, 1000);
}

/*
    async function stopRecording(send) {
            if (!mediaRecorder) return;
            mediaRecorder.onstop = async () => {
                clearInterval(recTimerInt);
                document.getElementById('recording-ui').style.display = 'none';
                document.getElementById('mic-btn').style.display = 'block';
                document.getElementById('msg-input').style.display = 'block';

                if (send) {
                    // üü¢ FIX: USE CORRECT MIME TYPE FOR BLOB
                    // If Chrome, this is likely 'audio/webm;codecs=opus'
                    const mime = mediaRecorder.mimeType;
                    const audioBlob = new Blob(audioChunks, { type: mime });

                    if (audioBlob.size < 500) { alert("Recording too short."); return; }

                    const formData = new FormData();
                    formData.append('phone', currentPhone);
                    // Send as 'voice.blob', backend will rename to .opus
                    formData.append('file', audioBlob, 'voice.blob');
                    formData.append('type', 'audio');

                    isSending = true;
                    document.getElementById('messages').insertAdjacentHTML('beforeend', `<div class="msg sent">üé§ Sending voice...</div>`);

                    try {
                        await fetch('/send_attachment', {method: 'POST', body: formData});
                    } catch(e) { console.error(e); }

                    setTimeout(() => {
                        isSending = false;
                        refreshChat(true);
                    }, 1500);
                }
            };
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
        }
*/

async function stopRecording(send) {
    if (!mediaRecorder) return;

    mediaRecorder.onstop = async () => {
        clearInterval(recTimerInt);

        document.getElementById('recording-ui').style.display = 'none';
        document.getElementById('mic-btn').style.display = 'block';
        document.getElementById('msg-input').style.display = 'block';

        if (!send) return;

        const audioBlob = new Blob(audioChunks, {
            type: mediaRecorder.mimeType // usually audio/webm
        });

        if (audioBlob.size < 1000) {
            alert("Recording too short");
            return;
        }

        const formData = new FormData();
        formData.append('phone', currentPhone);
        formData.append('file', audioBlob, 'voice.webm'); // ‚úÖ browser format
        formData.append('type', 'audio');

        isSending = true;
        document.getElementById('messages')
            .insertAdjacentHTML('beforeend', `<div class="msg sent">üé§ Sending voice...</div>`);

        await fetch('/send_attachment', {
            method: 'POST',
            body: formData
        });

        setTimeout(() => {
            isSending = false;
            refreshChat(true);
        }, 1500);
    };

    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(t => t.stop());
}


    let contextMenuPhone=null;
    function showContextMenu(e,p) { e.preventDefault(); const m=document.getElementById('context-menu'); m.style.display='block'; m.style.left=e.pageX+'px'; m.style.top=e.pageY+'px'; contextMenuPhone=p; }
    window.addEventListener('click',()=>{document.getElementById('context-menu').style.display='none';});
    async function markChatUnread() {
        console.log('[UNREAD] markChatUnread clicked');

        if (!contextMenuPhone) return;

        // üî• Remember manual unread action
        locallyMarkedUnread.add(contextMenuPhone);

        // üî• Immediate UI update (no waiting for server)
        renderChatList();

        // üîÅ Sync backend
        try {
            await fetch('/mark_unread', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone: contextMenuPhone })
            });
        } catch (e) {
            console.error('[UNREAD] backend failed', e);
        }
    }


function openImageViewer(src) { const v=document.getElementById('image-viewer'); const i=document.getElementById('full-image'); i.src=src; v.style.display='flex'; }
    function closeImageViewer() { document.getElementById('image-viewer').style.display='none'; }

    // --- UTILS ---
    function getAvatarColor(key) { if(!key) return '#607D8B'; const colors=['#F44336','#E91E63','#9C27B0','#673AB7','#3F51B5','#2196F3','#009688','#4CAF50','#FF9800','#FF5722','#795548','#607D8B']; let h=0; for(let i=0;i<key.length;i++) h=key.charCodeAt(i)+((h<<5)-h); return colors[Math.abs(h)%colors.length]; }
    function getInitials(name) { if (!name) return "?"; const p=name.trim().split(" "); return p.length>=2?(p[0][0]+p[p.length-1][0]).toUpperCase():p[0][0].toUpperCase(); }
    function getTickHtml(s) { if(!s)return''; let i='done',c='sent'; if(s==='delivered'){i='done_all';c='delivered';} else if(s==='read'){i='done_all';c='read';} return `<span class="material-icons tick ${c}">${i}</span>`; }
    function linkify(t) { if(!t)return""; let f=t.replace(/\n/g,'<br>'); return f.replace(/(?:\+|00|0)(?:92|3)\d{9,13}/g, m=>`<span class="phone-link" onclick="handleLinkClick('${m}')">${m}</span>`); }
    function handleLinkClick(n) { openChat(n.replace(/\D/g,''), null); }
    // --- UI HELPER: TOGGLE SEND/MIC BUTTONS ---
        function checkInput() {
            const val = document.getElementById('msg-input').value.trim();
            const isExpired = document.getElementById('msg-input').disabled;

            // If session is expired, don't show buttons
            if (isExpired) return;

            // If text exists -> Show Send, Hide Mic
            // If text empty  -> Hide Send, Show Mic
            document.getElementById('send-btn').style.display = val ? 'block' : 'none';
            document.getElementById('mic-btn').style.display = val ? 'none' : 'block';
        }

        document.addEventListener('click', function (e) {
            const replyBox = e.target.closest('.reply-preview');
            if (!replyBox) return;

            const targetId = replyBox.dataset.replyId;
            dbg('Reply clicked, target wamid', targetId);

            if (!targetId) {
                dbg('ABORT: reply preview has no targetId');
                return;
            }

            const targetMsg = document.querySelector(`[data-wamid="${targetId}"]`);
            if (!targetMsg) {
                dbg('ABORT: target message not found in DOM');
                return;
            }

            isNavigatingToReply = true;

            const container = document.getElementById('messages');

            dbg('Before scroll', {
                containerScrollTop: container.scrollTop,
                targetOffsetTop: targetMsg.offsetTop
            });

            targetMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });

            setTimeout(() => {
                dbg('After scroll (300ms)', { containerScrollTop: container.scrollTop });
            }, 300);

            targetMsg.classList.add('reply-highlight');

            setTimeout(() => {
                targetMsg.classList.remove('reply-highlight');
                isNavigatingToReply = false;
                dbg('Navigation finished');
            }, 1200);
        });
        let contextMenuTargetMsg = null;

        document.addEventListener('click', function (e) {
            const arrow = e.target.closest('.msg-actions');
            const menu = document.getElementById('msg-context-menu');

            if (arrow) {
                e.stopPropagation();

                const msgDiv = arrow.closest('.msg');
                contextMenuTargetMsg = msgDiv;

                menu.style.display = 'block';
                menu.style.top = `${arrow.getBoundingClientRect().bottom + window.scrollY}px`;
                menu.style.left = `${arrow.getBoundingClientRect().left + window.scrollX - 100}px`;

                return;
            }

            // click anywhere else closes menu
            menu.style.display = 'none';
        });
        document.getElementById('msg-context-menu').addEventListener('click', function (e) {
            const action = e.target.dataset.action;
            if (!action || !contextMenuTargetMsg) return;

            const wamid = contextMenuTargetMsg.dataset.wamid;
            const msgObj = findMessageByWamid(wamid); // helper below

            if (!msgObj) return;

            if (action === 'reply') {
                setReplyTarget(msgObj);
            }

            if (action === 'forward') {
                alert('Forward coming soon');
            }

            if (action === 'delete') {
                alert('Delete coming soon');
            }

            this.style.display = 'none';
        });
        function setReplyTarget(m) {
            replyTarget = {
                whatsapp_id: m.whatsapp_id,
                sender: m.sender,
                message: m.message,
                media_type: m.media_type
            };

            showReplyBar(replyTarget);
        }

        // ‚¨áÔ∏è Focus input immediately (WhatsApp behavior)
        const input = document.getElementById('msg-input');
        if (input && !input.disabled) {
            input.focus();
        }

        function showReplyBar(rt) {
            const bar = document.getElementById('reply-bar');

            let previewText = '';
            let previewThumb = '';

            if (rt.message) {
                previewText = rt.message.substring(0, 80);
            } else if (rt.media_type === 'image' && rt.media_id) {
                previewText = 'Photo';
                previewThumb = `
                    <img
                      src="/media/${rt.media_id}"
                      class="reply-thumb"
                      loading="lazy"
                      onerror="this.style.display='none'"
                    >
                `;
            } else if (rt.media_type === 'video') {
                previewText = 'Video';
            } else if (rt.media_type === 'audio' || rt.media_type === 'voice') {
                previewText = 'üé§ Voice message';
            } else {
                previewText = 'Message';
            }

            bar.innerHTML = `
                <div class="reply-ui">
                    <div class="reply-strip"></div>
                    <div class="reply-body">
                        <div class="reply-name">
                            ${rt.sender === 'agent' ? 'You' : 'User'}
                        </div>
                        <div class="reply-row">
                            ${previewThumb}
                            <div class="reply-preview-text">${previewText}</div>
                        </div>
                    </div>
                    <div class="reply-close" onclick="clearReplyTarget()">‚úï</div>
                </div>
            `;

            bar.style.display = 'block';
        }
        function clearReplyTarget() {
          replyTarget = null;

          const bar = document.getElementById('reply-bar');
          if (bar) {
              bar.style.display = 'none';
              bar.innerHTML = '';
          }
      }

      function setReplyTarget(msg) {
          replyTarget = msg;

          renderReplyBar(msg);

          // ‚úÖ FORCE cursor to input (WhatsApp behavior)
          const input = document.getElementById('msg-input');
          input.disabled = false;
          input.focus();              // üî• THIS LINE
          input.setSelectionRange(input.value.length, input.value.length);
      }
      function setReplyTarget(msg) {
          replyTarget = msg;

          // ‚úÖ CALL THE CORRECT FUNCTION
          showReplyBar(msg);

          // ‚úÖ Focus input immediately (WhatsApp behavior)
          const input = document.getElementById('msg-input');
          if (input) {
              input.disabled = false;
              input.focus();
              input.setSelectionRange(input.value.length, input.value.length);
          }
      }
      function closeContextMenu() {
          closeMsgContextMenu();
          closeChatContextMenu();
      }

      function canDeleteForEveryone(msg) {
    if (!msg) return false;

    // 1Ô∏è‚É£ Only messages sent by agent
    if (msg.sender !== 'agent') return false;

    // 2Ô∏è‚É£ Must have WhatsApp message id
    if (!msg.whatsapp_id) return false;

    // 3Ô∏è‚É£ Must be within 1 hour
    const msgTime = new Date(msg.timestamp).getTime();
    const ONE_HOUR = 60 * 60 * 1000;

    return (Date.now() - msgTime) <= ONE_HOUR;
}
function isSessionActive() {
    return lastUserMsgTime && within24Hours(lastUserMsgTime);
}

</script>
</body>
</html>
