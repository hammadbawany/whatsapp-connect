<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dropbox Order Sync</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: none; margin-bottom: 20px; border-radius: 10px; }
        .header-title { color: #0d6efd; font-weight: 700; }
        .stat-number { font-size: 2.5rem; font-weight: 800; margin-bottom: 0; line-height: 1.2; }
        .source-badge { font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Status Borders */
        .border-left-success { border-left: 5px solid #198754; }
        .border-left-warning { border-left: 5px solid #ffc107; }
        .border-left-danger { border-left: 5px solid #dc3545; }
        .border-left-info { border-left: 5px solid #0dcaf0; }

        .table-hover tbody tr:hover { background-color: #f1f1f1; }
        .btn-chat { font-weight: 600; }
    </style>
</head>
<body>

<div class="container py-5">

    <!-- HEADER & ACTIONS -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="header-title"><i class="bi bi-dropbox"></i> Dropbox Order Sync</h2>
            <p class="text-muted mb-0">Compare folder names with WhatsApp history</p>
        </div>
        <div>
            <!-- AUTOMATION BUTTON -->
            <button onclick="previewAutomation()" class="btn btn-warning me-2 fw-bold text-dark shadow-sm">
                <i class="bi bi-robot"></i> Run Design Sender
            </button>

            <!-- REFRESH BUTTON -->
            <a href="/auto_no_response" class="btn btn-outline-primary">
                <i class="bi bi-arrow-clockwise"></i> Refresh Data
            </a>
        </div>
    </div>

    <!-- SUMMARY CARDS -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-number">{{ total }}</div>
                        <div class="small opacity-75">Total Folders Scanned</div>
                    </div>
                    <i class="bi bi-folder2-open fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-number">{{ unparsed|length }}</div>
                        <div class="small opacity-75">Unparsed / Error</div>
                    </div>
                    <i class="bi bi-exclamation-triangle fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-number">{{ responded|length }}</div>
                        <div class="small opacity-75">Ready to Send (Replied)</div>
                    </div>
                    <i class="bi bi-check-circle fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-number">{{ no_response|length }}</div>
                        <div class="small opacity-75">No Response (Waiting)</div>
                    </div>
                    <i class="bi bi-hourglass-split fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- SECTION 1: UNPARSED FOLDERS (Manual Check) -->
    {% if unparsed %}
    <div class="card border-left-danger mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0 text-danger"><i class="bi bi-hand-index-thumb"></i> Check Manually (Unparsed Folders)</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-danger py-2 mb-3">
                <small><i class="bi bi-info-circle"></i> These folder names could not be parsed. Please rename them or check manually.</small>
            </div>
            <ul class="list-group list-group-flush">
                {% for folder in unparsed %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span class="text-truncate font-monospace" style="max-width: 85%;">{{ folder }}</span>
                        <span class="badge bg-danger">Error</span>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- SECTION 2: RESPONDED / ELIGIBLE -->
    <div class="card border-left-success">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-success"><i class="bi bi-whatsapp"></i> Eligible for Delivery (Replied)</h5>
            <span class="badge bg-success">{{ responded|length }} orders</span>
        </div>
        <div class="card-body">
            {% if responded %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Order Code</th>
                            <th>Source</th>
                            <th>Customer Name</th>
                            <th>Phone Number</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in responded %}
                        <tr>
                            <td><span class="badge bg-dark">{{ item.order_code if item.order_code else 'N/A' }}</span></td>
                            <td>
                                {% if 'whatsapp' in item.source|lower %}
                                    <span class="badge bg-success source-badge"><i class="bi bi-whatsapp"></i> WhatsApp</span>
                                {% else %}
                                    <span class="badge bg-info text-dark source-badge"><i class="bi bi-globe"></i> {{ item.source }}</span>
                                {% endif %}
                            </td>
                            <td class="fw-bold">{{ item.customer_name }}</td>
                            <td>{{ item.phone }}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <!-- 1. Open Chat Button -->
                                    <a href="/inbox?phone={{ item.phone }}" target="_blank" class="btn btn-outline-success btn-sm" title="Open Chat">
                                        <i class="bi bi-chat-dots-fill"></i>
                                    </a>

                                    <!-- 2. Manual Send Button (Single) -->
                                    <button onclick="sendSingleDesign(this, '{{ item.folder_name }}', '{{ item.phone }}', '{{ item.full_path | replace('\\', '\\\\') }}')"
                                            class="btn btn-primary btn-sm"
                                            title="Send All PNGs Manually">
                                        <i class="bi bi-send-fill"></i> Send
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <p class="text-muted text-center p-3">No eligible orders found (All sent or waiting for reply).</p>
            {% endif %}
        </div>
    </div>

    <!-- SECTION 3: NO RESPONSE -->
    <div class="card border-left-warning mt-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-dark"><i class="bi bi-pause-circle"></i> Waiting for Response (Website Orders)</h5>
            <span class="badge bg-secondary">{{ no_response|length }} orders</span>
        </div>
        <div class="card-body">
            <div class="alert alert-warning py-2 mb-2">
                <small><i class="bi bi-exclamation-circle"></i> These customers placed orders via Website but have <strong>not messaged</strong> us on WhatsApp yet. Use a Template.</small>
            </div>
            {% if no_response %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Order Code</th>
                            <th>Source</th>
                            <th>Customer Name</th>
                            <th>Phone Number</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in no_response %}
                        <tr>
                            <td><span class="badge bg-secondary">{{ item.order_code if item.order_code else 'N/A' }}</span></td>
                            <td><span class="badge bg-light text-dark border source-badge">{{ item.source }}</span></td>
                            <td>{{ item.customer_name }}</td>
                            <td>{{ item.phone }}</td>
                            <td>
                                <a href="/inbox?phone={{ item.phone }}" target="_blank" class="btn btn-outline-dark btn-sm btn-chat">
                                    <i class="bi bi-send"></i> Send Template
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <p class="text-muted text-center p-3">No pending folders found.</p>
            {% endif %}
        </div>
    </div>

    <!-- SECTION 4: ALREADY SENT (COMPLETED) -->
    {% if completed %}
    <div class="card mt-4 border-left-info">
        <div class="card-header bg-white">
            <h5 class="mb-0 text-info"><i class="bi bi-check-all"></i> Already Sent (Completed)</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-light text-muted py-2 mb-2">
                <small>The design files for these <strong>{{ completed|length }} orders</strong> have already been sent.</small>
            </div>
            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                <table class="table table-sm text-muted table-hover">
                    <thead>
                        <tr><th>Order Code</th><th>Customer</th><th>Phone</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                        {% for item in completed %}
                        <tr>
                            <td><span class="badge bg-light text-dark border">{{ item.order_code }}</span></td>
                            <td>{{ item.customer_name }}</td>
                            <td>{{ item.phones[0] }}</td>
                            <td><span class="badge bg-info text-dark">Sent</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<!-- ========================== -->
<!-- AUTOMATION PREVIEW MODAL -->
<!-- ========================== -->
<div class="modal fade" id="previewModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title fw-bold text-dark"><i class="bi bi-robot"></i> Auto-Send Designs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="scanLoader" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Preparing list...</p>
                </div>

                <div id="previewContent" style="display: none;">
                    <div class="alert alert-info">
                        Found <strong><span id="previewCount">0</span></strong> folders that match criteria:
                        <ul class="mb-0 small">
                            <li>Source is WhatsApp OR (Website + User Replied)</li>
                            <li>Design has <strong>not</strong> been sent previously</li>
                        </ul>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm table-striped border">
                            <thead class="table-light">
                                <tr>
                                    <th>Folder Name</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="btnExecute" class="btn btn-success fw-bold" onclick="executeAutomation()" disabled>
                    <i class="bi bi-send-fill"></i> Confirm & Send All
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- AUTOMATION LOGIC -->
<script>
    let previewModal;

    // üî• EMBED DATA DIRECTLY FROM PYTHON (No API Call needed)
    // 'responded' matches the Green List variable passed from Flask
    const eligibleData = {{ responded | tojson }};

    async function previewAutomation() {
        // Init Modal
        const modalEl = document.getElementById('previewModal');
        previewModal = new bootstrap.Modal(modalEl);
        previewModal.show();

        // UI Reset
        document.getElementById('scanLoader').style.display = 'none';
        document.getElementById('previewContent').style.display = 'block';
        document.getElementById('btnExecute').disabled = true;

        // Populate Table
        const tbody = document.getElementById('previewTableBody');
        tbody.innerHTML = '';
        document.getElementById('previewCount').innerText = eligibleData.length;

        if (eligibleData.length > 0) {
            eligibleData.forEach(item => {
                const row = `
                    <tr>
                        <td class="text-truncate" style="max-width: 250px;" title="${item.folder_name}">
                            <small>${item.folder_name}</small>
                        </td>
                        <td>${item.phone}</td>
                        <td><span class="badge bg-success">Ready</span></td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
            document.getElementById('btnExecute').disabled = false;
        } else {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center p-3 text-muted">No eligible folders found in the current list.</td></tr>';
        }
    }

    async function executeAutomation() {
        if (!confirm(`Are you sure? This will send files to ${eligibleData.length} users.`)) return;

        const btn = document.getElementById('btnExecute');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';
        btn.disabled = true;

        try {
            // SEND THE LIST TO BACKEND
            const res = await fetch('/run_auto_design_delivery', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ folders: eligibleData })
            });

            const data = await res.json();

            let msg = `‚úÖ Process Complete!\n\nSent: ${data.sent_count}`;
            if (data.errors && data.errors.length > 0) {
                msg += `\n‚ùå Errors: ${data.errors.length}\n\n${data.errors.join('\n')}`;
            }
            alert(msg);
            location.reload();

        } catch (e) {
            alert("Execution failed: " + e);
            btn.innerHTML = "Retry";
            btn.disabled = false;
        }
    }

    // MANUAL SEND (Single)
    async function sendSingleDesign(btn, folderName, phone, fullPath) {
        if (!confirm(`Confirm sending ALL PNGs in folder:\n"${folderName}"\n\nTo: ${phone}\n\n(Note: 15s delay between images)`)) return;

        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';

        try {
            const res = await fetch('/manual_send_design', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    folder_name: folderName,
                    phone: phone,
                    full_path: fullPath
                })
            });

            const data = await res.json();

            if (res.ok) {
                let msg = `‚úÖ Success! Sent ${data.sent_count} / ${data.total_found} images.`;
                if (data.errors && data.errors.length > 0) {
                    msg += `\n\n‚ö†Ô∏è Some errors occurred:\n` + data.errors.join("\n");
                }
                alert(msg);
                location.reload(); // Reload to move item to "Completed" list
            } else {
                alert("‚ùå Error: " + (data.error || "Unknown error"));
            }

        } catch (e) {
            alert("‚ùå Network Error: " + e);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }
</script>

</body>
</html>
